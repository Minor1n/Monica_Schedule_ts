"use strict";var Ye=Object.create;var k=Object.defineProperty;var Ze=Object.getOwnPropertyDescriptor;var tr=Object.getOwnPropertyNames;var er=Object.getPrototypeOf,rr=Object.prototype.hasOwnProperty;var rt=(r,t)=>{for(var e in t)k(r,e,{get:t[e],enumerable:!0})},st=(r,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of tr(t))!rr.call(r,o)&&o!==e&&k(r,o,{get:()=>t[o],enumerable:!(s=Ze(t,o))||s.enumerable});return r};var S=(r,t,e)=>(e=r!=null?Ye(er(r)):{},st(t||!r||!r.__esModule?k(e,"default",{value:r,enumerable:!0}):e,r)),sr=r=>st(k({},"__esModule",{value:!0}),r);var Ur={};rt(Ur,{bot:()=>n});module.exports=sr(Ur);var U=class{constructor(t,e,s){t&&e&&s!==void 0&&(this.type=t,this._value=e,this._number=s)}async load(t,e){if(e)this.type=t,this._value=e.value,this._number=e.number;else{let s=await or.settings(t);this.type=s.type,this._value=s.value,this._number=s.number}return this}get value(){return this._value}set value(t){this._value=t,this.updateSetting("value",t)}get number(){return this._number}set number(t){this._number=t,this.updateSetting("number",t)}updateSetting(t,e){let s=`UPDATE settings SET ${t} = ? WHERE type = ?`;n.connection.query(s,[e,this.type],o=>{if(o)throw new Error("SQL ERROR in Settings - update")})}},or={settings:async r=>new Promise((t,e)=>{n.connection.query("SELECT * FROM settings WHERE type = ?",[r],(o,a)=>{o?e(new Error("SQL ERROR in Settings - select")):a.length>0?t(a[0]):e(new Error("No settings found for the given type"))})})};var T=class{constructor(t,e,s,o,a,i){this._bots=t,this._groupName=e,this._id=s,this._name=o,this._role=i,this._userName=a}get bots(){return this._bots}get groupName(){return this._groupName}get id(){return this._id}get name(){return this._name}get role(){return this._role}get userName(){return this._userName}set groupName(t){this._groupName=t,this.updateField("groupName",t)}set name(t){this._name=t,this.updateField("name",t)}set userName(t){this._userName=t,this.updateField("userName",t)}updateField(t,e){let s=`UPDATE users SET ${t} = ? WHERE userId = ?`;n.connection.query(s,[e,this._id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var P=class{constructor(t,e,s,o){this.id=t,this._count=e,this._day=s,this._lastDate=o}get count(){return this._count}get day(){return this._day}get lastDate(){return this._lastDate}set count(t){this._count=t,this.updateDatabase("dutyCount",t)}set day(t){this._day=t,this.updateDatabase("dutyDay",t)}set lastDate(t){this._lastDate=t,this.updateDatabase("dutyLastDate",t)}updateDatabase(t,e){let s=`UPDATE users SET ${t} = ? WHERE userId = ?`;n.connection.query(s,[e,this.id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var q=class{constructor(t,e,s,o,a){this.id=t,this._paid=e,this._price=s,this._status=o,this.referral=a}get paid(){return this._paid}get price(){return this._price}get status(){return this._status}set paid(t){this._paid=t,this.updateField("paidWhenever",t)}set status(t){this._status=t,this.updateField("payment",t)}updateField(t,e){let s=`UPDATE users SET ${t} = ? WHERE userId = ?`;n.connection.query(s,[e,this.id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var N=class{constructor(t,e,s,o,a,i){this.id=t,this._duty=e,this._lightMode=s,this._replacement=o,this._schedule=a,this._theme=i}get theme(){return this._theme}get schedule(){return this._schedule}get replacement(){return this._replacement}get lightMode(){return this._lightMode}get duty(){return this._duty}updateField(t,e){let s=`UPDATE users SET ${t} = ? WHERE userId = ?`;n.connection.query(s,[e,this.id],o=>{if(o)throw new Error("SQL ERROR in UserSettings")})}set theme(t){let e=/\.(jpeg|jpg|png)$/i.test(t),s=t==="standard"?"standard":e?t:this._theme;this._theme=s,this.updateField("theme",s)}set schedule(t){this._schedule=t,this.updateField("settingsSchedule",t)}set replacement(t){this._replacement=t,this.updateField("settingsReplacement",t)}set lightMode(t){this._lightMode=t,this.updateField("lightMode",t)}set duty(t){this._duty=t,this.updateField("settingsDuty",t)}switchStatus(t){return t==="on"?"off":"on"}switchSchedule(){this._schedule=this.switchStatus(this._schedule),this.updateField("settingsSchedule",this._schedule)}switchReplacement(){this._replacement=this.switchStatus(this._replacement),this.updateField("settingsReplacement",this._replacement)}switchLightMode(){this._lightMode=this._lightMode===0?1:0,this.updateField("lightMode",this._lightMode)}switchDuty(){this._duty=this.switchStatus(this._duty),this.updateField("settingsDuty",this._duty)}};var C=class{constructor(t,e){this._agents=new Map;this.id=t,this._key=e}async load(){try{let[t,e]=await Promise.all([ot.agents(this.id),ot.user(this.id)]);return t.forEach(s=>this._agents.set(s.userId,s)),this._agentsApprove=await this.calculateApprovedAgents(t),this._user=e,this}catch(t){throw console.error("Error loading UserReferral:",t),t}}get agentsApprove(){return this._agentsApprove}get agents(){return this._agents}get user(){return this._user}get key(){return this._key}insertReferral(t){this._agents.set(t,{agentId:this.id,userId:t,refKey:this._key}),n.connection.query("INSERT INTO referrals (agentId, userId, refKey) VALUES (?, ?, ?)",[this.id,t,this._key],s=>{s&&console.error("SQL ERROR in insertReferral:",s.message)})}async calculateApprovedAgents(t){let e=t.map(async o=>{let a=await new R().load(o.userId);return a.payment.status>1&&a.payment.paid==="true"?1:0});return(await Promise.all(e)).reduce((o,a)=>o+a,0)}},ot={agents:async r=>new Promise((t,e)=>{n.connection.query("SELECT * FROM referrals WHERE agentId = ?",[r],(o,a)=>{if(o)return e(new Error("SQL ERROR in UserReferral - agents: "+o.message));t(a)})}),user:async r=>new Promise((t,e)=>{n.connection.query("SELECT * FROM referrals WHERE userId = ?",[r],(o,a)=>{if(o)return e(new Error("SQL ERROR in UserReferral - user: "+o.message));t(a[0])})})};var _t=require("telegraf");var nt=S(require("dotenv"));nt.default.config();var{TOKEN:at,PASSWORD:it,SQLHOST:ut,SQLUSER:mt,SQLDATABASE:lt,SQLPASSWORD:pt}=process.env;if(!at||!it||!ut||!mt||!lt||!pt)throw new Error("Missing environment variables");var nr=["<html lang='ru-RUS'><head><meta charset='utf-8'/><title></title><style>","body{","margin: 0;","font-family: Arial, sans-serif;"].join(""),ar=["-moz-background-size: cover;","-o-background-size: cover;","background-size: cover;","height: fit-content;","width: fit-content;","}","table{","background-color: rgb(0,0,0,0.2);","padding: 10px;","}","td{","background-color: rgba(255,255,255,0.70);","padding: 0 3px;","text-align: center;","height: 25px;","min-width: 50px;","}",".line{","background-color: rgb(0,0,0,0.0);","height: 10px;max-height: 10px","}","</style></head><body><table>"].join(""),ir="</table></body></html>",dt=new Map().set(-1,"free").set(0,"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D, \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B \u043D\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D").set(1,"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D, \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B \u0447\u0430\u0441\u0442\u0438\u0447\u043D\u043E \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D").set(2,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 1 \u043C\u0435\u0441\u044F\u0446").set(3,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 2 \u043C\u0435\u0441\u044F\u0446\u0430").set(4,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430").set(5,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 4 \u043C\u0435\u0441\u044F\u0446\u0430").set(6,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 5 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(7,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 6 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(8,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 7 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(9,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 8 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(10,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 9 \u043C\u0435\u0441\u044F\u0446\u0435\u0432"),ur={args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--headless","--no-zygote","--disable-gpu"],headless:!0,ignoreHTTPSErrors:!0},ct={refBonus:(r,t)=>r===1177837026||r===6018898378?40*t:t>10?100:10*t,cost:(r,t,e)=>t-t/100*ct.refBonus(r,e),standard:(r,t)=>[`\u041E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 <b>${Math.round(r)}\u0440</b>`,`\u0412\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u043E\u043F\u043B\u0430\u0442\u0438\u0442\u044C \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u043C\u0435\u0441\u044F\u0446\u0435\u0432(${Math.round(r+t)}\u0440, ${Math.round(r+t*2)}\u0440, ${Math.round(r+t*3)}\u0440, ${Math.round(r+t*4)}\u0440, ${Math.round(r+t*5)}\u0440)`,"\u041F\u0440\u0438 \u043E\u043F\u043B\u0430\u0442\u0435, \u0432 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u0443\u043A\u0430\u0437\u044B\u0432\u0430\u0439\u0442\u0435 \u0432\u0430\u0448 id (id \u043C\u043E\u0436\u043D\u043E \u0443\u0437\u043D\u0430\u0442\u044C \u0432\u0432\u0435\u0434\u044F \u043A\u043E\u043C\u0430\u043D\u0434\u0443 /profile)","\u041F\u043E\u0441\u043B\u0435 \u043E\u043F\u043B\u0430\u0442\u044B \u043F\u0440\u043E\u043F\u0438\u0448\u0438\u0442\u0435 /paid \u0434\u043B\u044F \u043E\u043F\u043E\u0432\u0435\u0449\u0435\u043D\u0438\u044F \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u0435",'<a href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u0441\u0441\u044B\u043B\u043A\u0430 \u0434\u043B\u044F \u043E\u043F\u043B\u0430\u0442\u044B</a>',"","\u041F\u0440\u0438 \u043E\u043F\u043B\u0430\u0442\u0435 \u0437\u0430 \u0438\u044E\u043D\u044C \u0432\u044B \u043F\u043E\u043B\u0443\u0447\u0430\u0435\u0442\u0435 \u0441\u0442\u0430\u0442\u0443\u0441 \u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430"].join(`
`),ban:r=>[`\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0437\u0430 \u043D\u0435\u0443\u043F\u043B\u0430\u0442\u0443(\u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443 @a_korop \u0438\u043B\u0438 \u043E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 <b>${Math.round(r*2)}\u0440</b>)`,'\u{1F517}<a href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u0441\u0441\u044B\u043B\u043A\u0430 \u0434\u043B\u044F \u043E\u043F\u043B\u0430\u0442\u044B</a>'].join(`
`),changeStatus:r=>`\u0412\u0430\u0448 \u0441\u0442\u0430\u0442\u0443\u0441 \u0438\u0437\u043C\u0435\u043D\u0435\u043D \u043D\u0430 ${dt.get(r)}`},mr={user:'<b class="profileB">\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start</b>',group:'<b class="profileB">\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443 /setGroup</b>'},lr={user:"'\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start'",group:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443 /setgroup"},pr="http://rgkript.ru/raspisanie-zanyatiy/",u={TOKEN:at,PASSWORD:it,SQLHOST:ut,SQLUSER:mt,SQLDATABASE:lt,SQLPASSWORD:pt,htmlStart1:nr,htmlStart2:ar,htmlEnd:ir,puppeteer:ur,payment:dt,paymentMessages:ct,fetchUrl:pr,notfoundMessagesSite:mr,notfoundMessages:lr};var ft=async r=>{if(r.payment.status===1){let t=u.paymentMessages.cost(r.info.id,r.payment.price,r.payment.referral.agentsApprove);await n.telegram.sendMessage(r.info.id,u.paymentMessages.standard(t,r.payment.price),{parse_mode:"HTML"}).catch(console.log)}};var gt=async()=>{let r=["31.01","28.02","31.03","30.04","31.05","30.06","31.07","31.08","30.09","31.10","30.11","31.12"][new Date().getMonth()];n.users.all.filter(t=>t.payment.status===1).forEach(t=>t.sendText(`\u041E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u0434\u043E ${r}, \u0438\u043D\u0430\u0447\u0435 \u0431\u0443\u0434\u0435\u0442\u0435 \u043E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u044B \u043E\u0442 \u0431\u043E\u0442\u0430`))};var ht=async()=>{let r=n.users.all.sort((e,s)=>e.info.name.localeCompare(s.info.name)),t=[];return r.forEach((e,s)=>{s%5===0&&t.push([]),t[t.length-1].push({text:e.info.name,callback_data:`userPaid${e.info.id}`})}),t};var yt=async r=>{if(r.info.id>=0)return!0;let t=await n.telegram.getChatMembersCount(r.info.id),e=r.info.bots,s=n.users.all.map(async o=>{if(o.info.id!==r.info.id&&(o.payment.status===-1||o.payment.status>2)){let a=await n.telegram.getChatMember(r.info.id,o.info.id);["member","creator","administrator"].includes(a.status)&&(e+=1)}});return await Promise.all(s),e===t};var bt=async()=>{for(let r of n.users.all){let t=u.paymentMessages.cost(r.info.id,r.payment.price,r.payment.referral.agentsApprove);if(!(t<=0)){switch(r.payment.status){case 1:r.sendText(u.paymentMessages.ban(r.payment.price));break;case 2:r.sendText(u.paymentMessages.standard(t,r.payment.price));break;default:r.payment.status>2&&r.sendText(u.paymentMessages.changeStatus(r.payment.status-1));break}r.payment.status>0&&r.payment.status--}}};var wt=async(r,t)=>{if(!r)return"\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start";if(r.payment.paid!=="false"||!r.payment.referral.user)return"\u0412\u044B \u0443\u0436\u0435 \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043B\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447, \u043B\u0438\u0431\u043E \u043E\u043F\u043B\u0430\u0447\u0438\u0432\u0430\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u0440\u0430\u043D\u0435\u0435";let e=n.users.getUserByRefKey(t);return e?r.info.id===e.info.id?"\u0412\u044B \u043D\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0441\u0432\u043E\u0439 \u0436\u0435 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447":(r.payment.status+=1,e.payment.referral.insertReferral(r.info.id),`\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043D \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447!
\u0412\u0430\u0448 \u0441\u0442\u0430\u0442\u0443\u0441 \u0438\u0437\u043C\u0435\u043D\u0435\u043D \u043D\u0430 ${u.payment.get(r.payment.status)}`):`\u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u0430\u0433\u0435\u043D\u0442 \u0434\u043B\u044F \u043A\u043B\u044E\u0447\u0430: ${t}`};var g={alert:ft,preAlert:gt,generateUsersKeyboard:ht,groupIsPaid:yt,recount:bt,setReferralKey:wt};var R=class{constructor(){}async load(t,e){let s=e?.res?e.res:e?.refKey?await St.refKey(e.refKey):await St.userId(t),{settings:o,info:a,duty:i,payment:m}=await this.loadOptions(s);return this.settings=o,this.info=a,this.duty=i,this.payment=m,this}async loadOptions(t){let e=await new C(t.userId,t.refKey).load();return{duty:new P(t.userId,t.dutyCount,t.dutyDay,t.dutyLastDate),info:new T(t.groupBots,t.groupName,t.userId,t.name,t.userName,t.role),payment:new q(t.userId,t.paidWhenever,t.price,t.payment,e),settings:new N(t.userId,t.settingsDuty,t.lightMode,t.settingsReplacement,t.settingsSchedule,t.theme)}}sendText(t){n.devMode&&this.info.id!==6018898378||(n.telegram.sendMessage(this.info.id,t,{parse_mode:"HTML"}).catch(e=>{console.log(e)}),g.alert(this).catch(e=>{console.log(e)}))}sendAutoDeleteText(t,e){n.telegram.sendMessage(this.info.id,t,{parse_mode:"HTML"}).then(s=>{setTimeout(()=>{n.telegram.deleteMessage(s.chat.id,s.message_id).catch(o=>{console.log(o)})},e)}).catch(s=>{console.log(s)}),g.alert(this).catch(s=>{console.log(s)})}sendPhoto(t,e){n.telegram.sendPhoto(this.info.id,_t.Input.fromBuffer(t,e)).catch(s=>{console.log(s)}),g.alert(this).catch(s=>{console.log(s)})}},St={refKey:async r=>vt("SELECT * FROM users WHERE refKey = ?",[r]),userId:async r=>vt("SELECT * FROM users WHERE userId = ?",[r])};async function vt(r,t){return new Promise((e,s)=>{n.connection.query(r,t,(o,a)=>{if(o)return s(new Error(`SQL ERROR ${o}`));a[0]?e(a[0]):s(new Error("USER not found"))})})}var xt=S(require("node-html-to-image"));var y=class{constructor(t,e){this.gradient=t,this.html=e}async getImage(){let t=`${u.htmlStart1}${this.gradient}${u.htmlStart2}${this.html}${u.htmlEnd}`;return await(0,xt.default)({html:t,puppeteerArgs:u.puppeteer})}};var L=class{constructor(){this.map=new Map;this._all=[]}async load(){let t=await dr.all();return this._all=await Promise.all(t.map(async e=>{let s=await new R().load(e.userId,e);return this.map.set(e.userId,s),s})),this}async createUser(t,e,s,o,a){return new Promise((i,m)=>{n.connection.query("INSERT INTO users (userId, userName, payment, name, refKey) VALUES (?, ?, ?, ?, ?)",[t,e,s,o,a],async(c,l)=>{if(c)return m(new Error("SQL ERROR in Users"));try{let p=await new R().load(t,{res:l[0]});this.map.set(t,p),this._all.push(p),i()}catch(p){m(p)}})})}getUser(t){return this.map.get(t)}getUserByRefKey(t){return this._all.find(e=>e.payment.referral.key===t)}get all(){return this._all}getGroupUsers(t){return this._all.filter(e=>e.info.groupName===t)}async sendPhoto(t,e,s,o,a){await Promise.all(this._all.map(async i=>{let m=i.settings.theme,c=a&&m!=="standard"?await new y(m,a).getImage():t,l=o?await g.groupIsPaid(i):!0;if(i.payment.status!==0&&i.settings[s]==="on"&&l){if(n.devMode&&i.info.id!==6018898378)return;i.sendPhoto(c,e)}}))}sendText(t){for(let e of this._all)if(e.payment.status!==0){if(n.devMode&&e.info.id!==6018898378)return;e.sendText(t)}}},dr={all:async()=>new Promise((r,t)=>{n.connection.query("SELECT * FROM users",(e,s)=>{if(e)return t(new Error("SQL ERROR in Users"));r(s)})})};var B=class{constructor(){this._light=[];this._dark=[]}get light(){return this.getRandomGradient(this._light)}get dark(){return this.getRandomGradient(this._dark)}getRandomGradient(t){if(t.length===0)return"";let e=Math.floor(Math.random()*t.length);return t[e].css}async load(){return(await cr.gradients()).forEach(e=>{e.type==="light"?this._light.push(e):this._dark.push(e)}),this}},cr={gradients:async()=>new Promise((r,t)=>{n.connection.query("SELECT * FROM gradients",(e,s)=>{e?t(new Error("SQL ERROR in Gradients")):r(s)})})};var Mt=S(require("xlsx"));var H=class{constructor(t,e,s){this.groupName=t,this.html=e,this.link=s}setSchedule(t,e){this.html=t,this.link=e,n.connection.query(`UPDATE groups SET schedule = '${t}' WHERE name = '${this.groupName}'`)}async generateSchedule(t,e){let s=Mt.default.read(Buffer.from(await t.clone().arrayBuffer())),o=s.SheetNames,a=s.Sheets[o[1]],i=[];for(let l in a)if(l.startsWith("B")&&a[l].v===this.groupName){let p=Number(l.slice(1))-2,v=p+27;i.push(`<tr><td colspan="7"><b>${a[`B${p}`].v}</b></td></tr>`);for(let w=p+1;w<=v;w++){let d=`<tr>${["A","B","C","D","E","F","G"].map(b=>a[`${b}${w}`]?`<td><b>${a[`${b}${w}`].v}</b></td>`:"<td></td>").join(" ")}</tr>`;i.push((w-p+1)%4===0?`${d}<tr><td colspan="7" class="line"></td></tr>`:d)}break}let c=i.map(l=>l.replace(/ +/g," ")).join("");return this.setSchedule(c,e),c}};var G=class{constructor(t,e,s){this._duties=s,this.groupName=t,this._users=e}getDuty(t,e){return this._duties.filter(s=>s.date>t&&s.date<e)}insertDuty(t,e,s){this._duties.push({group:this.groupName,date:t,user:e,name:s}),n.connection.query(`INSERT INTO duty (\`group\`,\`date\`,\`user\`,\`name\`) values('${this.groupName}','${t}','${e}','${s}')`)}generateHTML(t){let e=this._users,s=Array(6).fill(null).map(()=>[]),o=Array(6).fill(null).map(()=>[]),a=Array(6).fill(null).map(()=>[]),i=[],m=[],c=[];e.forEach(d=>{d.duty.day!==-1&&s[d.duty.day-1].push(d.info.name)}),e.sort((d,b)=>b.duty.count-d.duty.count).forEach(d=>{d.duty.day!==-1&&a[d.duty.day-1].push(`${d.info.name}-${d.duty.count}`)});let l=new Date(Date.now()-6048e5*t),p=new Date(l.setDate(l.getDate()-l.getDay())),v=new Date(p);v.setDate(p.getDate()+6),this.getDuty(p.getTime(),v.getTime()).forEach(d=>{let b=new Date(d.date).getDay();b!==0&&o[b-1].push(d.name)});for(let d=0;d<5;d++){let b=Xe=>`<tr>${Xe.map(Je=>`<td><b>${Je[d]||""}</b></td>`).join("")}</tr>`;i.push(b(s)),m.push(b(o)),c.push(b(a))}let x=d=>{let b=new Date(p.getTime()+864e5*d);return`${b.getDate()}.${`0${b.getMonth()+1}`.slice(-2)}`};return`
<tr><td colspan="6"><b>\u0414\u0435\u0436\u0443\u0440\u043D\u044B\u0435 \u043F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td></tr>
<tr><td><b>\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A</b></td><td><b>\u0412\u0442\u043E\u0440\u043D\u0438\u043A</b></td><td><b>\u0421\u0440\u0435\u0434\u0430</b></td><td><b>\u0427\u0435\u0442\u0432\u0435\u0440\u0433</b></td><td><b>\u041F\u044F\u0442\u043D\u0438\u0446\u0430</b></td><td><b>\u0421\u0443\u0431\u0431\u043E\u0442\u0430</b></td></tr>
<tr><td colspan="6" class="line"></td></tr>
${i.join("")}
<tr><td colspan="6" class="line"></td></tr>
<tr><td colspan="6"><b>\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438</b></td></tr>
<tr>
${[1,2,3,4,5,6].map(d=>`<td><b>${x(d)}</b></td>`).join("")}
</tr>
<tr><td colspan="6" class="line"></td></tr>
${m.join("")}
<tr><td colspan="6" class="line"></td></tr>
<tr><td colspan="6"><b>\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0435\u0436\u0443\u0440\u0441\u0442\u0432</b></td></tr>
${c.join("")}
`}};var D=class{constructor(){}async load(t,e){let s=e?{name:t,schedule:e}:await Rt.groups(t);this.name=s.name,this.schedule=new H(this.name,s.schedule,(await new U().load("scheduleLink")).value);let o=await Rt.duty(t);return this._duty=new G(this.name,this.users,o),this}get users(){return n.users.getGroupUsers(this.name)}get duty(){return this._duty}async sendPhoto(t,e,s,o,a){for(let i of n.users.getGroupUsers(this.name)){let m=i.settings.theme,c=a&&m!=="standard"?await new y(m,a).getImage():t,l=o?await g.groupIsPaid(i):!0;if(i.payment.status!==0&&i.settings[s]==="on"&&l){if(n.devMode&&i.info.id!==6018898378)return;i.sendPhoto(c,e)}}}},Rt={groups:async r=>new Promise((t,e)=>{n.connection.query("SELECT * FROM groups WHERE name = ?",[r],(s,o)=>{s?e(new Error("SQL ERROR in Group")):t(o[0])})}),duty:async r=>new Promise((t,e)=>{n.connection.query("SELECT * FROM duty WHERE `group` = ?",[r],(s,o)=>{s?e(new Error("SQL ERROR in Group Duty")):t(o)})})};var Q=class{constructor(){this.all=[]}async load(){let t=await fr.replacements();return this.all=t.reverse(),this}insertReplacement(t,e,s){let o={link:t,date:e,html:s};this.all.push(o),n.connection.query("INSERT INTO replacements (link, date, html) VALUES (?, ?, ?)",[t,e,s],i=>{if(i)throw new Error("SQL ERROR in Replacements - insert")})}getReplacement(t){return this.all[t]}},fr={replacements:async()=>new Promise((r,t)=>{n.connection.query("SELECT * FROM replacements",(s,o)=>{s?t(new Error("SQL ERROR in Replacements - select")):r(o)})})};var $t=require("telegraf");var It=require("mysql");var Ut=S(require("xlsx")),A=class{constructor(){this.all=[];this.map=new Map}async load(){let t=await gr.all();return this.all=await Promise.all(t.map(async e=>{let s=await new D().load(e.name,e.schedule.html);return this.map.set(e.name,s),s})),this}isGroupInText(t){return t=t.replace(" ","-").toLowerCase(),this.all.find(e=>t.includes(e.name.toLowerCase()))}getGroup(t){return this.map.get(t)}async parseGroups(t){let e=await fetch(t),s=Ut.default.read(Buffer.from(await e.clone().arrayBuffer())),o=s.SheetNames,a=s.Sheets[o[1]],i=[];for(let m in a)m.startsWith("B")&&a[m].v.trim().match(/^[А-Я]+-[0-9][0-9]$|^[А-Я]+-[0-9][0-9][а-я]$/ig)&&(this.getGroup(a[m].v.trim())||(await this.setGroup(a[m].v.trim()),i.push(a[m].v.trim())));return`\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u044B \u0433\u0440\u0443\u043F\u043F\u044B: ${i.join(", ")}`}setGroup(t){return new Promise((e,s)=>{n.connection.query("INSERT INTO groups (name) VALUES (?)",[t],async o=>{if(o)return s(new Error("SQL ERROR in setGroup"));try{let a=await new D().load(t,"null");this.map.set(t,a),this.all.push(a),e()}catch(a){s(a)}})})}},gr={all:async()=>new Promise((r,t)=>{n.connection.query("SELECT * FROM groups",(e,s)=>{e?t(new Error("SQL ERROR in Groups")):r(s)})})};var hr={host:u.SQLHOST,user:u.SQLUSER,database:u.SQLDATABASE,password:u.SQLPASSWORD},O=class extends $t.Telegraf{constructor(){super(u.TOKEN);this.devMode=!1;this.connection=(0,It.createPool)(hr)}launchBot(){this.launch(),this.sendTemporaryMessage(6018898378,"\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D!"),console.log("\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D")}async loadData(e,s){let o=await e();return await this.sendTemporaryMessage(6018898378,s),console.log(s),o}async addGradients(){this.gradients=await this.loadData(()=>new B().load(),"\u0413\u0440\u0430\u0434\u0438\u0435\u043D\u0442\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addGroups(){this.groups=await this.loadData(()=>new A().load(),"\u0413\u0440\u0443\u043F\u043F\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addUsers(){this.users=await this.loadData(()=>new L().load(),"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addReplacements(){this.replacements=await this.loadData(()=>new Q().load(),"\u0417\u0430\u043C\u0435\u043D\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async sendTemporaryMessage(e,s){try{let o=await this.telegram.sendMessage(e,s);setTimeout(()=>{this.telegram.deleteMessage(o.chat.id,o.message_id).catch(console.error)},30*1e3)}catch(o){console.error(o)}}};var F=class{constructor(){this.all=new Map}async load(){let t=await yr.all();return await Promise.all(t.map(async e=>{let s=new U;await s.load(e.type,e),this.all.set(e.type,s)})),this}getSettings(t){return this.all.get(t)}},yr={all:()=>new Promise((r,t)=>{n.connection.query("SELECT * FROM settings",(s,o)=>{s?t(new Error("SQL ERROR in Settings")):r(o)})})};var Et=S(require("pdf-parse")),Dt=S(require("word-extractor")),br=new Dt.default,W=class{constructor(t,e){this.replIgnore=["\u0413\u0440\u0443\u043F\u043F\u0430","\u041F\u0410\u0420\u0410","\u041F\u0420\u0415\u041F\u041E\u0414\u0410\u0412\u0410\u0422\u0415\u041B\u042C","\u0417\u0410\u041C\u0415\u041D\u0410","\u0420\u0410\u0421\u041F\u0418\u0421\u0410\u041D\u0418\u042E"];this.buffer=t,this.fileType=e}async getData(){switch(this.fileType){case"doc":return(await br.extract(this.buffer)).getBody();case"pdf":return(await(0,Et.default)(this.buffer)).text}}async getReplacementData(){return this.data=await this.getData(),this.data.replace(/\t/g," ").split(`
`).filter(t=>!this.replIgnore.some(e=>t.startsWith(e))&&t.trim()!==""&&t.replace(/\s/g,"")!=="\u041F\u041E")}};var K=class{constructor(t){this._date=t.date,this.text=t.text,this._link=t.link}get date(){return this._date}get link(){return this._link}async getHtml(){return this._html=await this.generateHTML(),this._html}async parseText(){let t=[],e=0;for(;e<this.text.length;){let s=this.text[e];if(s?.match(/ЗАМЕНЫ/g))t.push({text:`${s} ${this.text[e+1]}`,group:null,pair:"null",auditorium:"null"}),e+=2;else{let o=n.groups.isGroupInText(s);if(o){let a=[s],i=1;for(;this.text[e+i]&&!n.groups.isGroupInText(String(this.text[e+i]))&&!this.text[e+i].match(/ЗАМЕНЫ/g);)a.push(this.text[e+i]),i++;let m=a.join(" ").slice(o.name.length+1).replace(/ +/g," "),[c]=m.split(/\. (?=[А-Яа-я0-9(])|\) (?=[А-Яа-я0-9(])/g).reverse(),l=m.match(/[0-9]п([,\-])[0-9]п|[0-9]([,\-])[0-9]п|[0-9]п|[0-9]/),p=l?l[0]:void 0,v=p?m.replace(p,"").replace(c,"").trim():m.trim();t.push({text:v,group:o,pair:p,auditorium:c}),e+=a.length}}}return t}async generateHTML(){let t=await this.parseText(),e=[],s=(i,m)=>!!(i[m+1]&&i[m+1].startsWith("(")),o=(i,m)=>`<tr><td><b>${i.group?.name||""}</b></td><td><b>${i.pair||""}</b></td>${m}<td><b>${i.auditorium||""}</b></td></tr>`,a=i=>{switch(i.length){case 1:return`<td colspan="2"><b>${i[0]}</b></td><td><b></b></td><td colspan="2"><b></b></td>`;case 2:return`<td colspan="2"><b>${i[0]}</b></td><td><b></b></td><td colspan="2"><b>${i[1]}</b></td>`;case 3:return`<td colspan="2"><b>${i[0]}</b></td><td><b>${i[1]}</b></td><td colspan="2"><b>${i[2]}</b></td>`;case 4:return`<td><b>${i[0]}</b></td><td><b>${i[1]}</b></td><td></td><td><b>${i[2]}</b></td><td><b>${i[3]}</b></td>`;default:return`<td colspan="5"><b>${i.join(" ")}</b></td>`}};for(let i of t)if(!i.group)e.push(`<tr><td colspan="8"><b>${i.text}</b></td></tr>`,'<tr><td><b>\u0413\u0440\u0443\u043F\u043F\u0430</b></td><td><b>\u041F\u0430\u0440\u0430</b></td><td colspan="2"><b>\u041F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td><td><b><===></b></td><td colspan="2"><b>\u0417\u0430\u043C\u0435\u043D\u0430</b></td><td><b>\u0410\u0443\u0434\u0438\u0442\u043E\u0440\u0438\u044F</b></td></tr>','<tr><td colspan="8" class="line"></td></tr>');else{let m=i.text.replace(/ +/g," ").match(/[А-Я][а-я]+ [А-Я].[А-Я].|\([а-я]+\)|\([А-Яа-я0-9 .]+ +[А-Яа-я0-9 .]+\)|[А-Яа-я0-9]+/g)||[],c=[],l=0;for(;l<m.length;)if(s(m,l)){let x=[m[l],`
${m[l+1]}`],d=2;for(;s(m,l+d);)x.push(`
${m[l+d]}`),d++;l+=d,c.push(x.join(" "))}else c.push(m[l]),l++;let p=a(c),w=t[t.indexOf(i)+1]?.group===null;e.push(o(i,p)),w&&e.push('<tr><td colspan="8" class="line"></td></tr>')}return e.join("")}};var j=require("telegraf"),z=async r=>[[j.Markup.button.callback(`\u0414\u0435\u0436\u0443\u0440\u0441\u0442\u0432\u0430: ${r.settings.duty}`,`settingsDuty${r.info.id}`),j.Markup.button.callback(`\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${r.settings.schedule}`,`settingsSchedule${r.info.id}`),j.Markup.button.callback(`\u0417\u0430\u043C\u0435\u043D\u044B: ${r.settings.replacement}`,`settingsReplacement${r.info.id}`)]];var kt=async(r,t,e)=>{let s=Number(t.replace(/^\D+/g,"")),o=n.users.getUser(s);if(!o){await r.reply(u.notfoundMessages.user);return}switch(e){case"duty":o.settings.switchDuty();break;case"schedule":o.settings.switchSchedule();break;case"replacement":o.settings.switchReplacement();break}await r.editMessageText("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438:",{reply_markup:{inline_keyboard:await z(o)}})};var Tt=async(r,t)=>{let e=parseInt(t.slice(10),10),s=n.users.getUser(e);if(!s){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}s.sendText("\u041E\u0448\u0438\u0431\u043A\u0430. \u0412\u044B \u043D\u0435 \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443!");let o=r.callbackQuery?.message?.message_id,a=r.callbackQuery?.from.id;o&&a&&await n.telegram.deleteMessage(a,o)};var Pt=async(r,t)=>{let e=r.from?.id,s=parseInt(t.slice(10),10),o=new Map([[1,"\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A"],[2,"\u0412\u0442\u043E\u0440\u043D\u0438\u043A"],[3,"\u0421\u0440\u0435\u0434\u0430"],[4,"\u0427\u0435\u0442\u0432\u0435\u0440\u0433"],[5,"\u041F\u044F\u0442\u043D\u0438\u0446\u0430"],[6,"\u0421\u0443\u0431\u0431\u043E\u0442\u0430"]]);if(!e)return;let a=n.users.getUser(e);if(!a){await r.reply(u.notfoundMessages.user);return}a.duty.day=s,await r.editMessageText(`\u0423\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D \u0434\u0435\u043D\u044C: ${o.get(s)}`)};var qt=async(r,t)=>{let e=r.from?.id,s=t.slice(8);if(!e)return;let o=n.users.getUser(e);if(!o){await r.reply(u.notfoundMessages.user);return}o.info.groupName=s,await r.editMessageText(`\u0423\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0433\u0440\u0443\u043F\u043F\u0430: ${s}`)};var Nt=require("telegraf");var $=async(r,t)=>{let s=[{label:"true",value:`userStatus_2___${t.info.id}`},{label:"false",value:`userStatus_1___${t.info.id}`},{label:"free",value:`userStatus_f___${t.info.id}`},{label:"vip",value:`userStatus_vip_${t.info.id}`},{label:"ban",value:`userStatus_0___${t.info.id}`},{label:"\u21A9\uFE0F",value:"userStatus_undo"}].map(o=>Nt.Markup.button.callback(o.label,o.value));await r.editMessageText(`\u0422\u0435\u043A\u0443\u0449\u0438\u0439 \u0441\u0442\u0430\u0442\u0443\u0441: ${u.payment.get(t.payment.status)}
\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u043D\u0430:`,{reply_markup:{inline_keyboard:[s]}})};var Ct=require("telegraf");var Lt=async(r,t)=>{let e=Number(t.split("_").pop()),s=n.users.getUser(e),o=[{label:"2\u043C\u0435\u0441",value:`vipStatus_3_${e}`},{label:"3\u043C\u0435\u0441",value:`vipStatus_4_${e}`},{label:"4\u043C\u0435\u0441",value:`vipStatus_5_${e}`},{label:"5\u043C\u0435\u0441",value:`vipStatus_6_${e}`},{label:"6\u043C\u0435\u0441",value:`vipStatus_7_${e}`},{label:"\u21A9\uFE0F",value:"userStatus_undo"}];if(t.includes("vip")){let a=o.map(i=>Ct.Markup.button.callback(i.label,i.value));await r.editMessageText("\u0423\u0440\u043E\u0432\u0435\u043D\u044C VIP:",{reply_markup:{inline_keyboard:[a]}})}else if(t.includes("undo")){let a=await g.generateUsersKeyboard();await r.editMessageText("\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u043B\u044F:",{reply_markup:{inline_keyboard:a}})}else if(s){let a=t.slice(11).startsWith("f")?-1:Number(t.charAt(11));s.payment.status=a,s.payment.paid="true",await $(r,s);let i=a===0?"\u0412\u044B \u0431\u044B\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C":u.paymentMessages.changeStatus(a);s.sendText(i)}else await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D")};var Bt=async(r,t)=>{let e=t.split("_"),s=parseInt(e[1],10),o=parseInt(e[2],10),a=n.users.getUser(o);if(!a){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}a.payment.status=s,a.payment.paid="true",await $(r,a);let i=u.paymentMessages.changeStatus(s);a.sendText(i)};var _={paidStatus:Tt,setDutyDay:Pt,setGroup:qt,userPaid:$,userStatus:Lt,vipStatus:Bt,settings:{keyboard:z,updateSettings:kt}};var Ht=()=>{n.on("callback_query",async r=>{let t=r.callbackQuery?.data;if(t)if(t.startsWith("userPaid")){let e=Number(t.slice(8)),s=n.users.getUser(e);if(!s){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}await _.userPaid(r,s)}else t.startsWith("paidStatus")?await _.paidStatus(r,t):t.startsWith("userStatus")?await _.userStatus(r,t):t.startsWith("vipStatus")?await _.vipStatus(r,t):t.startsWith("settings")?await _.settings.updateSettings(r,t,t.slice(8).toLowerCase().replace(/[0-9]+/g,"")):t.startsWith("setGroup")?await _.setGroup(r,t):t.startsWith("setDutyDay")&&await _.setDutyDay(r,t)})};async function Gt(r){if(!r.chat?.id||!r.from?.username)return;let t=r.chat.id,e=r.from.username;n.users.getUser(t)||(await n.users.createUser(t,e,2,e,await wr(t)),await n.telegram.sendMessage(6018898378,`${t} ${e}, \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0438\u043B\u0441\u044F \u043A \u0431\u043E\u0442\u0443`)),await r.reply(`\u0412\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043B\u0438 \u0431\u043E\u0442\u0430!
\u0414\u043B\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E\u0439 \u0440\u0430\u0431\u043E\u0442\u044B \u043F\u0440\u043E\u043F\u0438\u0448\u0438\u0442\u0435 (/setname \u0432\u0430\u0448\u0430 \u0444\u0430\u043C\u0438\u043B\u0438\u044F) \u0438 (/setgroup).
\u0412\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0432\u0432\u0435\u0441\u0442\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447 \u043A\u043E\u043C\u0430\u043D\u0434\u043E\u0439 (/referral \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447), \u0432\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u0435 \u0434\u043E\u0441\u0442\u0443\u043F \u043A\u043E \u0432\u0441\u0435\u043C \u0444\u0443\u043D\u043A\u0446\u0438\u044F\u043C \u043D\u0430 \u043C\u0435\u0441\u044F\u0446 \u0431\u0435\u0441\u043F\u043B\u0430\u0442\u043D\u043E (\u0434\u043E 1-\u0433\u043E \u0447\u0438\u0441\u043B\u0430 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u0433\u043E \u043C\u0435\u0441\u044F\u0446\u0430)`)}async function wr(r){return r<0?"null":r.toString().split("").map(Number).map(t=>(t||10)+64).map(t=>String.fromCharCode(t)).join("")}async function Qt(r){let t=r.chat?.id,e=r.text?.slice(6).trim();if(t!==6018898378||!e||e.startsWith("monica_schedule_bot")){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}n.users.sendText(e)}async function At(r){await r.reply("\u041D\u0435 \u0443\u0434\u0430\u043B\u044F\u0439\u0442\u0435 \u044D\u0442\u043E \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435!",{reply_markup:{resize_keyboard:!0,keyboard:[["\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B"]]}})}var Ot=async()=>{let r=n.gradients.light;for(let t of n.groups.all){let e=t.duty.generateHTML(0),s=await new y(r,e).getImage();await t.sendPhoto(s,"duty.png","duty",!0,e)}};var Ft=async(r,t)=>{try{let e=await fetch(r);if(!e.ok){console.log(`Failed to fetch: ${e.statusText}`),await n.telegram.sendMessage(6018898378,"\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B");return}let s=Buffer.from(await e.arrayBuffer()),o=r.slice(-3),a=new Date(`${t.slice(-4)}-${t.slice(3,5)}-${t.slice(0,2)}`).getTime(),i=new K({date:a,text:await new W(s,o).getReplacementData(),link:r}),m=n.replacements.getReplacement(0),c=await i.getHtml();if(c!==m?.html){n.replacements.insertReplacement(i.link,i.date,c);let l=n.gradients.dark,p=await new y(l,c).getImage();await n.users.sendPhoto(p,"replacement.png","replacement",!0,c)}}catch(e){console.log(`Error during processing: ${e}`),await n.telegram.sendMessage(6018898378,"\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B")}};var Wt=async r=>{try{let t=await fetch(r);if(!t.ok){await n.telegram.sendMessage(6018898378,"\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E");return}let e=n.groups.all;for(let s of e)if(s.users.length>0){await s.schedule.generateSchedule(t,r);let{html:o}=s.schedule;if(o&&o!=="null")try{let a=n.gradients.light,i=await new y(a,o).getImage();await s.sendPhoto(i,"schedule.png","schedule",!0,o)}catch(a){console.log(`Error while sending photo for group ${s.name}: ${a}`)}}}catch(t){console.log(`Error during processing: ${t}`),await n.telegram.sendMessage(6018898378,"\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E")}};var X={duty:Ot,replacement:Ft,schedule:Wt};async function Kt(r,t){if(r!==6018898378){t&&await t.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let e=n.users.getUser(r);if(!e)return;let s=await new F().load(),o=s.getSettings("scheduleLink"),a=s.getSettings("replacementLink"),i=await(await fetch(u.fetchUrl)).text(),m=new Date().getFullYear(),c=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+m+'[0-9/.\\-A-Za-z_]+"',"g"),l=/<strong>[А-Яа-я0-9. ]+/g,p=Array.from(new Set(i.match(c))).map(x=>x.slice(9,-1)),v=i.match(l);if(!v){e.sendText("DateArr not found");return}let w=v.map(x=>x.match(/[0-9]+.[0-9]+.[0-9]+/g)?.[0]).filter(Boolean);o&&p[0]!==o.value?(o.value=p[0],e.sendAutoDeleteText(`\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${w[0]} ${p[0].slice(36)}`,1e3*30),await X.schedule(p[0])):e.sendAutoDeleteText("\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E",1e3*30),a&&p[1]!==a.value?(a.value=p[1],e.sendAutoDeleteText(`\u0417\u0430\u043C\u0435\u043D\u044B: ${w[1]} ${p[1].slice(36)}`,1e3*30),await X.replacement(p[1],w[1])):e.sendAutoDeleteText("\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B",1e3*30)}async function jt(r){let t=r.chat?.id;if(!t){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430: \u0447\u0430\u0442 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}let e=n.users.getUser(t);if(!e){await r.reply(u.notfoundMessages.user);return}if(e.info.id<=0){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430. \u041A\u043E\u043C\u0430\u043D\u0434\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0438\u0437 \u0433\u0440\u0443\u043F\u043F\u044B");return}let s=`${e.info.name}(${e.info.id}) \u043E\u043F\u043E\u0432\u0435\u0441\u0442\u0438\u043B \u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u0435, \u0441\u0442\u0430\u0442\u0443\u0441: ${u.payment.get(e.payment.status)}`,o={inline_keyboard:[[{text:"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D\u043E",callback_data:`paidStatus${e.info.id}`},{text:"\u041E\u043F\u043B\u0430\u0447\u0435\u043D\u043E",callback_data:`userPaid${e.info.id}`}]]};await n.telegram.sendMessage(6018898378,s,{reply_markup:o}),await r.reply("\u0417\u0430\u043F\u0440\u043E\u0441 \u043D\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u043E\u043F\u043B\u0430\u0442\u044B \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D, \u043E\u0436\u0438\u0434\u0430\u0439\u0442\u0435")}async function zt(r){let t=r.chat?.id;if(!t)return;let e=n.users.getUser(t);if(!e){await r.reply(u.notfoundMessages.user);return}let{groupName:s,id:o,name:a}=e.info,i=e.payment.referral.key,m=u.paymentMessages.refBonus(e.info.id,e.payment.referral.agentsApprove),c=u.payment.get(e.payment.status),l=Math.floor(e.payment.price-e.payment.price*(m/100)),p=`
        \u0413\u0440\u0443\u043F\u043F\u0430: <b>${s}</b>
        Id: \u{1F517}<code>${o}</code>
        \u0424\u0430\u043C\u0438\u043B\u0438\u044F: <b>${a}</b>
        \u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u043F\u043B\u0430\u0442\u044B: <b>${c}</b>
        \u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u0441 \u0443\u0447\u0435\u0442\u043E\u043C \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043A\u0438: <b>${l}</b>
        \u0420\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447: \u{1F517}<code>${i}</code>
        \u0411\u043E\u043D\u0443\u0441 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043E\u0432: <b>${m}%</b>
        \u0421\u0432\u044F\u0437\u044C \u0441 \u0430\u0434\u043C\u0438\u043D\u043E\u043C: @a_korop
    `.replace(/\n +/g,`
`);await r.reply(p,{parse_mode:"HTML"})}async function Vt(r){let t=r.chat?.id,e=r.text?.slice(10).trim();if(!t)return;let s=n.users.getUser(t);if(!s){await r.reply(u.notfoundMessages.user);return}if(!e){await r.reply("\u0412\u044B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043B\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447(/referral \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447)");return}let o=await g.setReferralKey(s,e);await r.reply(o)}async function Xt(r){let t=r.chat?.id;if(!t)return;let e=n.users.getUser(t);if(!e){await r.reply(u.notfoundMessages.user);return}if(e.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B");return}if(!await g.groupIsPaid(e)){await r.reply("\u041D\u0435 \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u0433\u0440\u0443\u043F\u043F\u044B \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443");return}let o=n.replacements.getReplacement(0);if(!o){await r.reply("\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B");return}let a=e.settings.theme==="standard"?n.gradients.dark:`background-image: url(${e.settings.theme});`,i=await new y(a,o.html).getImage();e.sendPhoto(i,"schedule.png")}async function Jt(r){r.chat?.id===6018898378?(await r.reply("\u0411\u043E\u0442 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D!"),setTimeout(()=>{process.exit(0)},1e3*30)):await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412")}async function Yt(r){let t=r.chat?.id;if(!t)return;let e=n.users.getUser(t);if(!e){await r.reply(u.notfoundMessages.user);return}if(e.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B");return}let s=n.groups.getGroup(e.info.groupName);if(e.info.groupName==="null"||!s){await r.reply(u.notfoundMessages.group);return}let o=s.schedule.html;if(o==="null"){await r.reply("\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E");return}if(!await g.groupIsPaid(e)){await r.reply("\u041D\u0435 \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u0433\u0440\u0443\u043F\u043F\u044B \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443");return}let i=e.settings.theme==="standard"?n.gradients.light:`background-image: url(${e.settings.theme});`,m=await new y(i,o).getImage();e.sendPhoto(m,"schedule.png")}async function Zt(r){let t=r.chat?.id;if(!t)return;if(n.users.getUser(t)){n.groups.all.sort((o,a)=>o.name.localeCompare(a.name));let s=[];n.groups.all.forEach((o,a)=>{let i=Math.floor(a/5);s[i]||(s[i]=[]),s[i].push({text:o.name,callback_data:`setGroup${o.name}`})}),await r.reply("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443:",{reply_markup:{inline_keyboard:s}})}else await r.reply(u.notfoundMessages.user)}async function te(r){if(!r.chat?.id)return;let t=n.users.getUser(r.chat.id);if(!t){await r.reply(u.notfoundMessages.user);return}let e=r.text?.slice(9);e?(t.info.name=e,await r.reply(`\u0412\u0430\u0448\u0435 \u0438\u043C\u044F - ${e}`)):await r.reply("\u0412\u044B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043B\u0438 \u0438\u043C\u044F (/setname \u0432\u0430\u0448\u0435 \u0438\u043C\u044F)")}async function ee(r){if(!r.chat?.id)return;let t=n.users.getUser(r.chat.id);if(!t){await r.reply(u.notfoundMessages.user);return}let e=await _.settings.keyboard(t);await r.reply("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438:",{reply_markup:{inline_keyboard:e}})}async function re(r){if(r.chat?.id!==6018898378){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let t=await g.generateUsersKeyboard();await r.reply("\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u043B\u044F:",{reply_markup:{inline_keyboard:t}})}async function se(r){if(!r.chat?.id)return;let t=n.users.getUser(r.chat.id);if(!t){await r.reply(u.notfoundMessages.user);return}if(t.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C");return}let e=r.text?.slice(7);if(!e||e.startsWith("monica_schedule_bot")){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430,\u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443, \u043A\u043E\u043C\u0430\u043D\u0434\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0438\u0437 \u0433\u0440\u0443\u043F\u043F\u044B \u0438\u043B\u0438 \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0435 \u0432\u0435\u0434\u0435\u0442 \u043D\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443");return}t.settings.theme=e,await r.reply(`\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0442\u0435\u043C\u0430: ${t.settings.theme}`)}async function oe(r){let t=r.chat?.id;if(!t)return;if(!n.users.getUser(t)){await r.reply(u.notfoundMessages.user);return}let o=[{name:"\u041F\u043D\u0434",value:1},{name:"\u0412\u0442\u0440",value:2},{name:"\u0421\u0440\u0434",value:3},{name:"\u0427\u0442\u0432",value:4},{name:"\u041F\u0442\u043D",value:5},{name:"\u0421\u0431\u0442",value:6}].map(a=>({text:a.name,callback_data:`setDutyDay${a.value}`}));await r.reply("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0434\u0435\u043D\u044C:",{reply_markup:{inline_keyboard:[o]}})}async function ne(r){if(r.from?.id!==6018898378){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let t=await(await fetch(u.fetchUrl)).text(),e=new Date().getFullYear(),s=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+e+'[0-9/.\\-A-Za-z_]+"',"g"),o=Array.from(new Set(t.match(s))).map(i=>i.slice(9,-1)),a=await n.groups.parseGroups(o[0]);await r.reply(a)}var h={start:Gt,send:Qt,duty:At,fetch:Kt,paid:jt,profile:zt,referral:Vt,replacement:Xt,restart:Jt,schedule:Yt,setGroup:Zt,setName:te,settings:ee,status:re,theme:se,setDutyDay:oe,parseGroups:ne};var Sr={start:h.start,fetch:r=>h.fetch(r.chat.id,r),send:h.send,schedule:h.schedule,theme:h.theme,status:h.status,settings:h.settings,profile:h.profile,setname:h.setName,setgroup:h.setGroup,referral:h.referral,paid:h.paid,replacement:h.replacement,restart:h.restart,duty:h.duty,setdutydate:h.setDutyDay,parsegroups:h.parseGroups},ae=()=>{Object.entries(Sr).forEach(([r,t])=>{n.command(r,async e=>{await t(e)})})};var ie=require("cron");var J=(r,t)=>{new ie.CronJob(r,async()=>{try{await t()}catch(e){console.error(e)}},null,!0)},ue=()=>{J("0 10 14 * * 1-5,7",()=>h.fetch(6018898378)),J("0 0 13 1 * *",g.recount),J("0 35 7 25-31 * *",g.preAlert)};var tt=S(require("express")),Fe=S(require("cors")),et=S(require("path")),We=S(require("http"));var me=async r=>({table:n.replacements.getReplacement(r)?.html??"null"});var le={table:me};var pe=r=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};let e=n.groups.getGroup(t.info.groupName);return e?{table:e.schedule.html!=="null"?e.schedule.html:"<tr><td><b>\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E!</b></td></tr>"}:{table:u.notfoundMessagesSite.group}};var de=r=>{let t=n.groups.getGroup(r);return t?{table:t.schedule.html!=="null"?t.schedule.html:"<tr><td><b>\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E!</b></td></tr>"}:{table:u.notfoundMessagesSite.group}};var ce=r=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};let e=[],s=[];for(let o of n.groups.all.values())o.name===t.info.groupName?e.push(`<option selected value='${o.name}'>${o.name}</option>`):o.schedule.html==="null"?s.push(`<option disabled value='${o.name}'>${o.name}</option>`):e.push(`<option value='${o.name}'>${o.name}</option>`);return{table:e.concat(s).join("")}};var fe={table:pe,update:de,select:ce};var ge={replacement:le,schedule:fe};var he=(r,t)=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};let s=n.groups.getGroup(e.info.groupName);return s?{table:s.duty.generateHTML(t)}:{table:u.notfoundMessagesSite.group}};var ye=r=>{let t=n.users.getUser(r);if(!t)return{alert:u.notfoundMessagesSite.user};let e=n.groups.getGroup(t.info.groupName);if(!e)return{alert:u.notfoundMessagesSite.group};let s=Date.now(),o=new Date().getDay();if(o!==0&&t.payment.status!==0&&t.duty.lastDate+432e5<=s){e.duty.insertDuty(s,t.info.id,t.info.name),t.duty.count+=1,t.duty.lastDate=s;let a=e.users.filter(i=>(i.info.role==="admin"||i.duty.day===o)&&i.info.groupName===t.info.groupName);for(let i of a);return{alert:"\u0423\u0441\u043F\u0435\u0448\u043D\u043E!"}}else return{alert:"\u0421\u0435\u0433\u043E\u0434\u043D\u044F \u0432\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435, \u0432\u044B \u0443\u0436\u0435 \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438 \u0438\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B"}};var be={table:he,checkin:ye};var we=(r,t)=>{let e=n.users.getUser(r);if(!e)return u.notfoundMessagesSite.user;let s=Math.floor(u.paymentMessages.cost(e.info.id,e.payment.price,e.payment.referral.agentsApprove)+(t-1)*e.payment.price);return`\u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u043D\u0430 ${t} \u043C\u0435\u0441\u044F\u0446\u0435\u0432: ${s}`};var Se=async(r,t)=>{let e=n.users.getUser(r);return e?g.setReferralKey(e,t):u.notfoundMessagesSite.user};var ve=r=>{let t=u.paymentMessages.refBonus(r.info.id,r.payment.referral.agentsApprove),e=new Map([[1,"\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A"],[2,"\u0412\u0442\u043E\u0440\u043D\u0438\u043A"],[3,"\u0421\u0440\u0435\u0434\u0430"],[4,"\u0427\u0435\u0442\u0432\u0435\u0440\u0433"],[5,"\u041F\u044F\u0442\u043D\u0438\u0446\u0430"],[6,"\u0421\u0443\u0431\u0431\u043E\u0442\u0430"],[-1,"\u041D\u0435 \u0437\u0430\u0434\u0430\u043D\u043E"]]),s=Array.from(n.groups.all.values()).map(i=>`<option value='${i.name}' ${i.name===r.info.groupName?"selected":""}>${i.name}</option>`).join(""),o=Array.from(e.entries()).map(([i,m])=>`<option value='${i}' ${i===r.duty.day?"selected":""}>${m}</option>`).join(""),a=Math.floor(r.payment.price-r.payment.price*(t/100));return`
<tr class="fiveHeight" xmlns="http://www.w3.org/1999/html"><td colspan="2"><b class="profileB">\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F</b></td><td><b class="profileB">\u041D\u0430\u0441\u0442\u0440\u043E\u0438\u0442\u044C</b></td></tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0413\u0440\u0443\u043F\u043F\u0430:</b></td>
    <td><b class="profileB">${r.info.groupName}</b></td>
    <td><b class="profileB">
        <form style="overflow: hidden; vertical-align: middle;" name="myForm">
            <img src="assets/images/pen.svg" alt="pen" style="width: 5vw; height: auto; padding-right: 1vw; float: right">
            <span style="overflow: hidden; height: 100%; vertical-align: middle; display: list-item;">
                <select style="width: 100%; display: list-item;font-size: 3vw;margin: 1vw" id="selectGroup" name="selectGroup" required/>${s}</select>
            </span>
        </form>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0418\u043C\u044F:</b></td>
    <td><b class="profileB">${r.info.name}</b></td>
    <td><b class="profileB">
        <form style="overflow: hidden;" name="myForm1">
            <img src="assets/images/pen.svg" alt="pen" style="width: 5vw; height: auto; padding-right: 1vw; float: right">
            <span style="overflow: hidden; display: block"><input style="width: 100%; height: 100%" class="inputP" type="text" id="nameUpdate" name="nameUpdate" required/></span>
        </form>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0414\u0435\u043D\u044C \u0434\u0435\u0436\u0443\u0440\u0441\u0442\u0432\u0430:</b></td>
    <td><b class="profileB">${e.get(r.duty.day)}</b></td>
    <td><b class="profileB">
        <form style="overflow: hidden; vertical-align: middle;" name="myForm2">
            <img src="assets/images/pen.svg" alt="pen" style="width: 5vw; height: auto; padding-right: 1vw; float: right">
            <span style="overflow: hidden; height: 100%; vertical-align: middle; display: list-item;">
                <select style="width: 100%; display: list-item;font-size: 3vw;margin: 1vw" id="selectDutyDay" name="selectDutyDay" required/>${o}</select>
            </span>
        </form>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0422\u0435\u043B\u0435\u0433\u0440\u0430\u043C id:</b></td>
    <td><b class="profileB">${r.info.id}</b></td>
    <td><b class="profileB"><i>\u0423\u043A\u0430\u0437\u044B\u0432\u0430\u0439\u0442\u0435 \u0432 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u043F\u043B\u0430\u0442\u0435\u0436\u0430</i></b></td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u043F\u043B\u0430\u0442\u044B:</b></td>
    <td><b class="profileB">${u.payment.get(r.payment.status)}</b></td>
    <td><b class="profileB">\u0420\u0430\u0441\u0447\u0438\u0442\u0430\u0442\u044C \u0441\u0443\u043C\u043C\u0443 \u043E\u043F\u043B\u0430\u0442\u044B \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u043C\u0435\u0441\u044F\u0446\u0435\u0432<br>
        <form style="overflow: hidden;" name="myForm4">
            <img src="assets/images/pen.svg" alt="pen" style="width: 5vw; height: auto; padding-right: 1vw; float: right">
            <span style="overflow: hidden; display: block"><input style="width: 100%;" class="inputP" type="text" id="monthPay" name="monthPay" required/></span>
        </form>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u0441 \u0443\u0447\u0435\u0442\u043E\u043C \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043A\u0438:</b></td>
    <td><b class="profileB">${a}\u0440</b></td>
    <td><b class="profileB"><a style="text-decoration: none" href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u043D\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u043E\u043F\u043B\u0430\u0442\u044B</a></b></td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0420\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447:</b></td>
    <td><b class="profileB">${r.payment.referral.key}</b></td>
    <td><b class="profileB">
        <form style="overflow: hidden;" name="myForm3">
            <img src="assets/images/pen.svg" alt="pen" style="width: 5vw; height: auto; padding-right: 1vw; float: right">
            <span style="overflow: hidden; display: block"><input style="width: 100%; height: 100%" class="inputP" type="text" id="refKey" name="refKey" required/></span>
        </form>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0411\u043E\u043D\u0443\u0441 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043E\u0432:</b></td>
    <td><b class="profileB">${t}%</b></td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0421\u0432\u044F\u0437\u044C \u0441 \u0430\u0434\u043C\u0438\u043D\u043E\u043C:</b></td>
    <td><b class="profileB">@a_korop</b></td>
</tr>
<tr class="fiveHeight">
    <td colspan="2"></td>
    <td><button onclick="update()">
        <img src="assets/images/drive.svg" alt="drive" style="width: 5vw; height: auto;">
    </button></td>
</tr>
`};var _e=r=>{let t=n.users.getUser(r);return t?{table:ve(t)}:{table:u.notfoundMessagesSite.user}};var xe={monthPay:we,refKey:Se,table:_e};var Me={};var Re=(r,t)=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.duty.day=t};var Ue=(r,t)=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.info.groupName=t};var $e=(r,t)=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.info.name=t};var Ie={dutyDay:Re,group:Ue,name:$e};var Ee={info:xe,referrals:Me,settings:Ie};var Y=new Map([["off",'<img src="assets/images/bellMute.svg" alt="bellMute" style="width: 5vw; height: auto"/>'],["on",'<img src="assets/images/bell.svg" alt="bellMute" style="width: 5vw; height: auto"/>']]),M=r=>`
<tr class="fiveHeight"><td colspan="2"><b class="profileB">\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0439</b></td></tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u041F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u043E\u0432\u043E\u0433\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044F:</b></td>
    <td style="min-width: 10vw">
        <button onclick="updateSettingsNotificationSchedule()">
            ${Y.get(r.settings.schedule)}
        </button>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u041F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u043E\u0432\u044B\u0445 \u0437\u0430\u043C\u0435\u043D:</b></td>
    <td style="min-width: 10vw">
        <button onclick="updateSettingsNotificationReplacement()">
            ${Y.get(r.settings.replacement)}
        </button>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0420\u0430\u0441\u0441\u044B\u043B\u043A\u0430 \u0442\u0430\u0431\u043B\u0438\u0446\u044B \u0434\u0435\u0436\u0443\u0440\u043D\u044B\u0445 \u0437\u0430 \u043D\u0435\u0434\u0435\u043B\u044E:</b></td>
    <td style="min-width: 10vw">
        <button onclick="updateSettingsNotificationDuty()">
            ${Y.get(r.settings.duty)}
        </button>
    </td>
</tr>
`;var De=r=>{let t=n.users.getUser(r);return t?(t.settings.switchDuty(),{table:M(t)}):{table:u.notfoundMessagesSite.user}};var ke=r=>{let t=n.users.getUser(r);return t?(t.settings.switchReplacement(),{table:M(t)}):{table:u.notfoundMessagesSite.user}};var Te=r=>{let t=n.users.getUser(r);return t?(t.settings.switchSchedule(),{table:M(t)}):{table:u.notfoundMessagesSite.user}};var Pe=r=>{let t=n.users.getUser(r);return t?{table:M(t)}:{table:u.notfoundMessagesSite.user}};var qe={duty:De,replacement:ke,schedule:Te,table:Pe};var vr=new Map([[0,'<img src="assets/images/sun.svg" alt="sun" style="width: 5vw; height: auto"/>'],[1,'<img src="assets/images/moon.svg" alt="moon" style="width: 5vw; height: auto"/>']]),I=r=>`
<tr class="fiveHeight"><td colspan="4"><b class="profileB">\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0442\u0435\u043C\u044B</b></td></tr>
<tr class="fiveHeight">
    <td colspan="2"><b class="profileB">\u0422\u0435\u043C\u043D\u0430\u044F \u0442\u0435\u043C\u0430:</b></td>
    <td colspan="2">
        <button style="width: 100%;" onclick="updateSettingsThemeLightMode()">
            ${vr.get(r.settings.lightMode)}
        </button>
    </td>
</tr>
<tr class="fiveHeight">
    <td><b class="profileB">\u0424\u043E\u043D:</b></td>
    <td>
        <form style="overflow: hidden;" name="myForm">
            <img src="assets/images/pen.svg" alt="pen" style="width: 5vw; height: auto; padding-right: 1vw; float: right">
            <span style="overflow: hidden; display: block"><input style="width: 100%; height: 100%" class="inputP" type="url" id="theme" name="theme" required/></span>
        </form>
    </td>
    <td><button onclick="updateSettingsThemeCustom()">
        <img src="assets/images/drive.svg" alt="drive" style="width: 5vw; height: auto;">
    </button></td>
    <td><button onclick="updateSettingsThemeStandard()">
        <img src="assets/images/return.svg" alt="return" style="width: 5vw; height: auto;">
    </button></td>
</tr>
    `;var Ne=(r,t)=>{let e=n.users.getUser(r);return e?(e.settings.theme=t,{table:I(e)}):{table:u.notfoundMessagesSite.user}};var Ce=r=>{let t=n.users.getUser(r);return t?(t.settings.switchLightMode(),{table:I(t)}):{table:u.notfoundMessagesSite.user}};var Le=r=>{let t=n.users.getUser(r);return{table:t?I(t):u.notfoundMessagesSite.user}};var Be={background:Ne,lightMode:Ce,table:Le};var He={notifications:qe,theme:Be};var Ge=r=>{let t=n.users.getUser(r);if(!t)return{gradient:n.gradients.light.slice(11,-1)};let{theme:e,lightMode:s}=t.settings,o=s===0?n.gradients.light:n.gradients.dark;return{gradient:e==="standard"?o.slice(11,-1):`url(${e})`}};var Z={};rt(Z,{duty:()=>xr,home:()=>_r,profile:()=>Mr,settings:()=>Rr});var Qe=require("fs"),Ae=S(require("path"));function _r(r,t){let e=n.users.getUser(t);return!e||e.payment.status===0?{body:Oe()}:{body:V(r,"home")}}function xr(r,t){let e=n.users.getUser(t);return!e||e.payment.status===0?{body:Oe()}:{body:V(r,"duty")}}function Mr(r){return{body:V(r,"profile")}}function Rr(r){return{body:V(r,"settings")}}function V(r,t){return(0,Qe.readFileSync)(Ae.default.join(r,`/site/${t}.html`),"utf-8")}function Oe(){return'<table><tr><td><b class="profileB">\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0438\u043B\u0438 \u0435\u0449\u0435 \u043D\u0435 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B \u043A \u0431\u043E\u0442\u0443!</b></td></tr></table>'}var f={home:ge,duty:be,profile:Ee,settings:He,pages:Z,gradient:Ge};var Ke=r=>{let t=(0,tt.default)();t.use((0,Fe.default)()),t.use("/assets",tt.default.static(r+"/site/assets")),t.get("/",(s,o)=>{n.devMode?(console.log(1),o.sendFile(et.default.join(r+"/site/index.dev.html"))):o.sendFile(et.default.join(r+"/site/index.html"))}),t.get("/home",async(s,o)=>{o.send(f.pages.home(r,Number(s.query.user)))}),t.get("/home/schedule/table",async(s,o)=>{o.send(f.home.schedule.table(Number(s.query.user)))}),t.get("/home/schedule/select",async(s,o)=>{o.send(f.home.schedule.select(Number(s.query.user)))}),t.get("/home/schedule/update",async(s,o)=>{o.send(f.home.schedule.update(String(s.query.group)))}),t.get("/home/replacement/table",async(s,o)=>{o.send(await f.home.replacement.table(Number(s.query.page)))}),t.get("/duty",async(s,o)=>{o.send(f.pages.duty(r,Number(s.query.user)))}),t.get("/duty/table",async(s,o)=>{o.send(f.duty.table(Number(s.query.user),Number(s.query.page)))}),t.get("/duty/checkin",async(s,o)=>{o.send(f.duty.checkin(Number(s.query.user)))}),t.get("/profile",async(s,o)=>{o.send(f.pages.profile(r))}),t.get("/profile/info/table",async(s,o)=>{o.send(f.profile.info.table(Number(s.query.user)))}),t.get("/profile/settings/group",async(s,o)=>{let a=f.profile.settings.group(Number(s.query.user),String(s.query.group));a?o.send(a):o.send()}),t.get("/profile/settings/dutyDay",async(s,o)=>{let a=f.profile.settings.dutyDay(Number(s.query.user),Number(s.query.day));a?o.send(a):o.send()}),t.get("/profile/settings/name",async(s,o)=>{let a=f.profile.settings.name(Number(s.query.user),String(s.query.name));a?o.send(a):o.send()}),t.get("/profile/info/refKey",async(s,o)=>{let a=await f.profile.info.refKey(Number(s.query.user),String(s.query.refKey));o.send({alert:a})}),t.get("/profile/info/monthPay",async(s,o)=>{let a=f.profile.info.monthPay(Number(s.query.user),Number(s.query.months));o.send({alert:a})}),t.get("/settings",async(s,o)=>{o.send(f.pages.settings(r))}),t.get("/settings/notifications/table",async(s,o)=>{o.send(f.settings.notifications.table(Number(s.query.user)))}),t.get("/settings/notifications/schedule",async(s,o)=>{o.send(f.settings.notifications.schedule(Number(s.query.user)))}),t.get("/settings/notifications/replacement",async(s,o)=>{o.send(f.settings.notifications.replacement(Number(s.query.user)))}),t.get("/settings/notifications/duty",async(s,o)=>{o.send(f.settings.notifications.duty(Number(s.query.user)))}),t.get("/settings/theme/table",async(s,o)=>{o.send(f.settings.theme.table(Number(s.query.user)))}),t.post("/settings/theme/background",async(s,o)=>{o.send(f.settings.theme.background(Number(s.query.user),String(s.query.url)))}),t.post("/settings/theme/lightMode",async(s,o)=>{o.send(f.settings.theme.lightMode(Number(s.query.user)))}),t.get("/gradient",async(s,o)=>{o.send(f.gradient(Number(s.query.user)))}),We.default.createServer(t).listen(3e3,"localhost")};var je=async r=>{let t=r.chat?.id;if(t)try{let e=n.users.getUser(t),s=Date.now(),o=new Date().getDay();if(!e){await r.reply(u.notfoundMessages.user);return}if(o!==0&&e.payment.status!==0&&e.duty.lastDate+432e5<=s){let a=n.groups.getGroup(e.info.groupName);if(!a){await r.reply(u.notfoundMessages.group);return}a.duty.insertDuty(s,e.info.id,e.info.name),e.duty.count+=1,e.duty.lastDate=s;let i=a.users.filter(m=>(m.info.role==="admin"||m.duty.day===o)&&m.info.groupName===e.info.groupName);for(let m of i)m.sendText(`${e.info.name} \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B, \u0435\u0441\u043B\u0438 \u043D\u0435\u0442 \u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443`);await r.reply("\u0423\u0441\u043F\u0435\u0448\u043D\u043E")}else await r.reply("\u0421\u0435\u0433\u043E\u0434\u043D\u044F \u0432\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435, \u0432\u044B \u0443\u0436\u0435 \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438 \u0438\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B")}catch(e){console.log(`Error processing duty: ${e}`),await n.telegram.sendMessage(t,"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435 \u0432\u0430\u0448\u0435\u0433\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u0430.")}};var ze={duty:je};var Ve=()=>{n.hears("\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B",async r=>{await ze.duty(r)})};var E={CallbackQueryHandler:Ht,CommandsHandler:ae,CronHandler:ue,WebHandler:Ke,HearsHandler:Ve};var n=new O;(async()=>(console.log("\u0414\u0435\u0432 \u043C\u043E\u0434: ",n.devMode),await n.addGradients(),await n.addUsers(),await n.addGroups(),await n.addReplacements(),E.WebHandler(n.devMode?__dirname.slice(0,-4):__dirname.slice(0,-5)),E.CommandsHandler(),E.CallbackQueryHandler(),E.HearsHandler(),E.CronHandler(),n.launchBot()))();0&&(module.exports={bot});
