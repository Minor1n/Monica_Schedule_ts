"use strict";var Ft=Object.create;var q=Object.defineProperty;var jt=Object.getOwnPropertyDescriptor;var zt=Object.getOwnPropertyNames;var Vt=Object.getPrototypeOf,Yt=Object.prototype.hasOwnProperty;var Xt=(r,e)=>{for(var t in e)q(r,t,{get:e[t],enumerable:!0})},J=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of zt(e))!Yt.call(r,o)&&o!==t&&q(r,o,{get:()=>e[o],enumerable:!(s=jt(e,o))||s.enumerable});return r};var M=(r,e,t)=>(t=r!=null?Ft(Vt(r)):{},J(e||!r||!r.__esModule?q(t,"default",{value:r,enumerable:!0}):t,r)),Zt=r=>J(q({},"__esModule",{value:!0}),r);var yr={};Xt(yr,{bot:()=>n});module.exports=Zt(yr);var R=class{constructor(e,t,s){e&&t&&s!==void 0&&(this.type=e,this._value=t,this._number=s)}async load(e,t){if(t)this.type=e,this._value=t.value,this._number=t.number;else{let s=await Jt.settings(e);this.type=s.type,this._value=s.value,this._number=s.number}return this}get value(){return this._value}set value(e){this._value=e,this.updateSetting("value",e)}get number(){return this._number}set number(e){this._number=e,this.updateSetting("number",e)}updateSetting(e,t){let s=`UPDATE settings SET ${e} = ? WHERE type = ?`;n.connection.query(s,[t,this.type],o=>{if(o)throw new Error("SQL ERROR in Settings - update")})}},Jt={settings:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM settings WHERE type = ?",[r],(o,a)=>{o?t(new Error("SQL ERROR in Settings - select")):a.length>0?e(a[0]):t(new Error("No settings found for the given type"))})})};var C=class{constructor(e,t,s,o,a,u){this._bots=e,this._groupName=t,this._id=s,this._name=o,this._role=u,this._userName=a}get bots(){return this._bots}get groupName(){return this._groupName}get id(){return this._id}get name(){return this._name}get role(){return this._role}get userName(){return this._userName}set groupName(e){this._groupName=e,this.updateField("groupName",e)}set name(e){this._name=e,this.updateField("name",e)}set userName(e){this._userName=e,this.updateField("userName",e)}updateField(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this._id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var L=class{constructor(e,t,s,o){this.id=e,this._count=t,this._day=s,this._lastDate=o}get count(){return this._count}get day(){return this._day}get lastDate(){return this._lastDate}set count(e){this._count=e,this.updateDatabase("dutyCount",e)}set day(e){this._day=e,this.updateDatabase("dutyDay",e)}set lastDate(e){this._lastDate=e,this.updateDatabase("dutyLastDate",e)}updateDatabase(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this.id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var G=class{constructor(e,t,s,o,a){this.id=e,this._paid=t,this._price=s,this._status=o,this.referral=a}get paid(){return this._paid}get price(){return this._price}get status(){return this._status}set paid(e){this._paid=e,this.updateField("paidWhenever",e)}set status(e){this._status=e,this.updateField("payment",e)}updateField(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this.id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var A=class{constructor(e,t,s,o,a,u){this.id=e,this._duty=t,this._lightMode=s,this._replacement=o,this._schedule=a,this._theme=u}get theme(){return this._theme}get schedule(){return this._schedule}get replacement(){return this._replacement}get lightMode(){return this._lightMode}get duty(){return this._duty}updateField(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this.id],o=>{if(o)throw new Error("SQL ERROR in UserSettings")})}set theme(e){let t=/\.(jpeg|jpg|png)$/i.test(e),s=e==="standard"?"standard":t?e:this._theme;this._theme=s,this.updateField("theme",s)}set schedule(e){this._schedule=e,this.updateField("settingsSchedule",e)}set replacement(e){this._replacement=e,this.updateField("settingsReplacement",e)}set lightMode(e){this._lightMode=e,this.updateField("lightMode",e)}set duty(e){this._duty=e,this.updateField("settingsDuty",e)}switchStatus(e){return e==="on"?"off":"on"}switchSchedule(){this._schedule=this.switchStatus(this._schedule),this.updateField("settingsSchedule",this._schedule)}switchReplacement(){this._replacement=this.switchStatus(this._replacement),this.updateField("settingsReplacement",this._replacement)}switchLightMode(){this._lightMode=this._lightMode===0?1:0,this.updateField("lightMode",this._lightMode)}switchDuty(){this._duty=this.switchStatus(this._duty),this.updateField("settingsDuty",this._duty)}};var Q=class{constructor(e,t){this._agents=new Map;this.id=e,this._key=t}async load(){try{let[e,t]=await Promise.all([ee.agents(this.id),ee.user(this.id)]);return e.forEach(s=>this._agents.set(s.userId,s)),this._agentsApprove=await this.calculateApprovedAgents(e),this._user=t,this}catch(e){throw console.error("Error loading UserReferral:",e),e}}get agentsApprove(){return this._agentsApprove}get agents(){return this._agents}get user(){return this._user}get key(){return this._key}insertReferral(e){this._agents.set(e,{agentId:this.id,userId:e,refKey:this._key}),n.connection.query("INSERT INTO referrals (agentId, userId, refKey) VALUES (?, ?, ?)",[this.id,e,this._key],s=>{s&&console.error("SQL ERROR in insertReferral:",s.message)})}async calculateApprovedAgents(e){let t=e.map(async o=>{let a=await new I().load(o.userId);return a.payment.status>1&&a.payment.paid==="true"?1:0});return(await Promise.all(t)).reduce((o,a)=>o+a,0)}},ee={agents:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM referrals WHERE agentId = ?",[r],(o,a)=>{if(o)return t(new Error("SQL ERROR in UserReferral - agents: "+o.message));e(a)})}),user:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM referrals WHERE userId = ?",[r],(o,a)=>{if(o)return t(new Error("SQL ERROR in UserReferral - user: "+o.message));e(a[0])})})};var be=require("telegraf");var te=M(require("dotenv"));te.default.config();var{TOKEN:re,PASSWORD:se,SQLHOST:ne,SQLUSER:oe,SQLDATABASE:ae,SQLPASSWORD:ie}=process.env;if(!re||!se||!ne||!oe||!ae||!ie)throw new Error("Missing environment variables");var er=["<html lang='ru-RUS'><head><meta charset='utf-8'/><title></title><style>","body{","margin: 0;","font-family: Arial, sans-serif;"].join(""),tr=["-moz-background-size: cover;","-o-background-size: cover;","background-size: cover;","height: fit-content;","width: fit-content;","}","table{","background-color: rgb(0,0,0,0.2);","padding: 10px;","}","td{","background-color: rgba(255,255,255,0.70);","padding: 0 3px;","text-align: center;","height: 25px;","min-width: 50px;","}",".line{","background-color: rgb(0,0,0,0.0);","height: 10px;max-height: 10px","}","</style></head><body><table>"].join(""),rr="</table></body></html>",ue=new Map().set(-1,"free").set(0,"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D, \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B \u043D\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D").set(1,"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D, \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B \u0447\u0430\u0441\u0442\u0438\u0447\u043D\u043E \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D").set(2,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 1 \u043C\u0435\u0441\u044F\u0446").set(3,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 2 \u043C\u0435\u0441\u044F\u0446\u0430").set(4,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430").set(5,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 4 \u043C\u0435\u0441\u044F\u0446\u0430").set(6,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 5 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(7,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 6 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(8,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 7 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(9,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 8 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(10,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 9 \u043C\u0435\u0441\u044F\u0446\u0435\u0432"),sr={args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--headless","--no-zygote","--disable-gpu"],headless:!0,ignoreHTTPSErrors:!0},me={refBonus:(r,e)=>r===1177837026||r===6018898378?40*e:e>10?100:10*e,cost:(r,e,t)=>e-e/100*me.refBonus(r,t),standard:(r,e)=>[`\u041E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 <b>${Math.round(r)}\u0440</b>`,`\u0412\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u043E\u043F\u043B\u0430\u0442\u0438\u0442\u044C \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u043C\u0435\u0441\u044F\u0446\u0435\u0432(${Math.round(r+e)}\u0440, ${Math.round(r+e*2)}\u0440, ${Math.round(r+e*3)}\u0440, ${Math.round(r+e*4)}\u0440, ${Math.round(r+e*5)}\u0440)`,"\u041F\u0440\u0438 \u043E\u043F\u043B\u0430\u0442\u0435, \u0432 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u0443\u043A\u0430\u0437\u044B\u0432\u0430\u0439\u0442\u0435 \u0432\u0430\u0448 id (id \u043C\u043E\u0436\u043D\u043E \u0443\u0437\u043D\u0430\u0442\u044C \u0432\u0432\u0435\u0434\u044F \u043A\u043E\u043C\u0430\u043D\u0434\u0443 /profile)","\u041F\u043E\u0441\u043B\u0435 \u043E\u043F\u043B\u0430\u0442\u044B \u043F\u0440\u043E\u043F\u0438\u0448\u0438\u0442\u0435 /paid \u0434\u043B\u044F \u043E\u043F\u043E\u0432\u0435\u0449\u0435\u043D\u0438\u044F \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u0435",'<a href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u0441\u0441\u044B\u043B\u043A\u0430 \u0434\u043B\u044F \u043E\u043F\u043B\u0430\u0442\u044B</a>',"","\u041F\u0440\u0438 \u043E\u043F\u043B\u0430\u0442\u0435 \u0437\u0430 \u0438\u044E\u043D\u044C \u0432\u044B \u043F\u043E\u043B\u0443\u0447\u0430\u0435\u0442\u0435 \u0441\u0442\u0430\u0442\u0443\u0441 \u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430"].join(`
`),ban:r=>[`\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0437\u0430 \u043D\u0435\u0443\u043F\u043B\u0430\u0442\u0443(\u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443 @a_korop \u0438\u043B\u0438 \u043E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 <b>${Math.round(r*2)}\u0440</b>)`,'\u{1F517}<a href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u0441\u0441\u044B\u043B\u043A\u0430 \u0434\u043B\u044F \u043E\u043F\u043B\u0430\u0442\u044B</a>'].join(`
`),changeStatus:r=>`\u0412\u0430\u0448 \u0441\u0442\u0430\u0442\u0443\u0441 \u0438\u0437\u043C\u0435\u043D\u0435\u043D \u043D\u0430 ${ue.get(r)}`},nr={user:'<b class="profileB">\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start</b>',group:'<b class="profileB">\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443 /setGroup</b>'},or={user:"'\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start'",group:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443 /setgroup"},ar="http://rgkript.ru/raspisanie-zanyatiy/",i={TOKEN:re,PASSWORD:se,SQLHOST:ne,SQLUSER:oe,SQLDATABASE:ae,SQLPASSWORD:ie,htmlStart1:er,htmlStart2:tr,htmlEnd:rr,puppeteer:sr,payment:ue,paymentMessages:me,fetchUrl:ar,notfoundMessagesSite:nr,notfoundMessages:or};var pe=async r=>{if(r.payment.status===1){let e=i.paymentMessages.cost(r.info.id,r.payment.price,r.payment.referral.agentsApprove);await n.telegram.sendMessage(r.info.id,i.paymentMessages.standard(e,r.payment.price),{parse_mode:"HTML"}).catch(console.log)}};var le=async()=>{let r=["31.01","28.02","31.03","30.04","31.05","30.06","31.07","31.08","30.09","31.10","30.11","31.12"][new Date().getMonth()];n.users.all.filter(e=>e.payment.status===1).forEach(e=>e.sendText(`\u041E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u0434\u043E ${r}, \u0438\u043D\u0430\u0447\u0435 \u0431\u0443\u0434\u0435\u0442\u0435 \u043E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u044B \u043E\u0442 \u0431\u043E\u0442\u0430`))};var ce=async()=>{let r=n.users.all.sort((t,s)=>t.info.name.localeCompare(s.info.name)),e=[];return r.forEach((t,s)=>{s%5===0&&e.push([]),e[e.length-1].push({text:t.info.name,callback_data:`userPaid${t.info.id}`})}),e};var de=async r=>{if(r.info.id>=0)return!0;let e=await n.telegram.getChatMembersCount(r.info.id),t=r.info.bots,s=n.users.all.map(async o=>{if(o.info.id!==r.info.id&&(o.payment.status===-1||o.payment.status>2)){let a=await n.telegram.getChatMember(r.info.id,o.info.id);["member","creator","administrator"].includes(a.status)&&(t+=1)}});return await Promise.all(s),t===e};var fe=async()=>{for(let r of n.users.all){let e=i.paymentMessages.cost(r.info.id,r.payment.price,r.payment.referral.agentsApprove);if(!(e<=0)){switch(r.payment.status){case 1:r.sendText(i.paymentMessages.ban(r.payment.price));break;case 2:r.sendText(i.paymentMessages.standard(e,r.payment.price));break;default:r.payment.status>2&&r.sendText(i.paymentMessages.changeStatus(r.payment.status-1));break}r.payment.status>0&&r.payment.status--}}};var ge=async(r,e)=>{if(!r)return"\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start";if(r.payment.paid!=="false"||!r.payment.referral.user)return"\u0412\u044B \u0443\u0436\u0435 \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043B\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447, \u043B\u0438\u0431\u043E \u043E\u043F\u043B\u0430\u0447\u0438\u0432\u0430\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u0440\u0430\u043D\u0435\u0435";let t=n.users.getUserByRefKey(e);return t?r.info.id===t.info.id?"\u0412\u044B \u043D\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0441\u0432\u043E\u0439 \u0436\u0435 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447":(r.payment.status+=1,t.payment.referral.insertReferral(r.info.id),`\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043D \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447!
\u0412\u0430\u0448 \u0441\u0442\u0430\u0442\u0443\u0441 \u0438\u0437\u043C\u0435\u043D\u0435\u043D \u043D\u0430 ${i.payment.get(r.payment.status)}`):`\u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u0430\u0433\u0435\u043D\u0442 \u0434\u043B\u044F \u043A\u043B\u044E\u0447\u0430: ${e}`};var g={alert:pe,preAlert:le,generateUsersKeyboard:ce,groupIsPaid:de,recount:fe,setReferralKey:ge};var I=class{constructor(){}async load(e,t){let s=t?.res?t.res:t?.refKey?await ye.refKey(t.refKey):await ye.userId(e),{settings:o,info:a,duty:u,payment:p}=await this.loadOptions(s);return this.settings=o,this.info=a,this.duty=u,this.payment=p,this}async loadOptions(e){let t=await new Q(e.userId,e.refKey).load();return{duty:new L(e.userId,e.dutyCount,e.dutyDay,e.dutyLastDate),info:new C(e.groupBots,e.groupName,e.userId,e.name,e.userName,e.role),payment:new G(e.userId,e.paidWhenever,e.price,e.payment,t),settings:new A(e.userId,e.settingsDuty,e.lightMode,e.settingsReplacement,e.settingsSchedule,e.theme)}}sendText(e){n.devMode&&this.info.id!==6018898378||(n.telegram.sendMessage(this.info.id,e,{parse_mode:"HTML"}).catch(t=>{console.log(t)}),g.alert(this).catch(t=>{console.log(t)}))}sendAutoDeleteText(e,t){n.telegram.sendMessage(this.info.id,e,{parse_mode:"HTML"}).then(s=>{setTimeout(()=>{n.telegram.deleteMessage(s.chat.id,s.message_id).catch(o=>{console.log(o)})},t)}).catch(s=>{console.log(s)}),g.alert(this).catch(s=>{console.log(s)})}sendPhoto(e,t){n.telegram.sendPhoto(this.info.id,be.Input.fromBuffer(e,t)).catch(s=>{console.log(s)}),g.alert(this).catch(s=>{console.log(s)})}sendButtons(e,t){n.telegram.sendMessage(this.info.id,e,{reply_markup:{inline_keyboard:t}}).catch(s=>{console.log(s)})}},ye={refKey:async r=>he("SELECT * FROM users WHERE refKey = ?",[r]),userId:async r=>he("SELECT * FROM users WHERE userId = ?",[r])};async function he(r,e){return new Promise((t,s)=>{n.connection.query(r,e,(o,a)=>{if(o)return s(new Error(`SQL ERROR ${o}`));a[0]?t(a[0]):s(new Error("USER not found"))})})}var we=M(require("node-html-to-image"));var w=class{constructor(e,t){this.gradient=e,this.html=t}async getImage(){let e=`${i.htmlStart1}${this.gradient}${i.htmlStart2}${this.html}${i.htmlEnd}`;return await(0,we.default)({html:e,puppeteerArgs:i.puppeteer})}};var O=class{constructor(){this.map=new Map;this._all=[]}async load(){let e=await ir.all();return this._all=await Promise.all(e.map(async t=>{let s=await new I().load(t.userId,t);return this.map.set(t.userId,s),s})),this}async createUser(e,t,s,o,a){return new Promise((u,p)=>{n.connection.query("INSERT INTO users (userId, userName, payment, name, refKey) VALUES (?, ?, ?, ?, ?)",[e,t,s,o,a],async(m,l)=>{if(m)return p(new Error("SQL ERROR in Users"));try{let c=await new I().load(e,{res:l[0]});this.map.set(e,c),this._all.push(c),u()}catch(c){p(c)}})})}getUser(e){return this.map.get(e)}getUserByRefKey(e){return this._all.find(t=>t.payment.referral.key===e)}get all(){return this._all}getGroupUsers(e){return this._all.filter(t=>t.info.groupName===e)}async sendPhoto(e,t,s,o,a){await Promise.all(this._all.map(async u=>{let p=u.settings.theme,m=a&&p!=="standard"?await new w(p,a).getImage():e,l=o?await g.groupIsPaid(u):!0;if(u.payment.status!==0&&u.settings[s]==="on"&&l){if(n.devMode&&u.info.id!==6018898378)return;u.sendPhoto(m,t)}}))}sendText(e){for(let t of this._all)if(t.payment.status!==0){if(n.devMode&&t.info.id!==6018898378)return;t.sendText(e)}}},ir={all:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM users",(t,s)=>{if(t)return e(new Error("SQL ERROR in Users"));r(s)})})};var B=class{constructor(){this._light=[];this._dark=[]}get light(){return this.getRandomGradient(this._light)}get dark(){return this.getRandomGradient(this._dark)}getRandomGradient(e){if(e.length===0)return"";let t=Math.floor(Math.random()*e.length);return e[t].css}async load(){return(await ur.gradients()).forEach(t=>{t.type==="light"?this._light.push(t):this._dark.push(t)}),this}},ur={gradients:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM gradients",(t,s)=>{t?e(new Error("SQL ERROR in Gradients")):r(s)})})};var Se=M(require("xlsx"));var H=class{constructor(e,t,s){this.groupName=e,this.html=t,this.link=s}setSchedule(e,t){this.html=e,this.link=t,n.connection.query(`UPDATE groups SET schedule = '${e}' WHERE name = '${this.groupName}'`)}async generateSchedule(e,t){let s=Se.default.read(Buffer.from(await e.clone().arrayBuffer())),o=s.SheetNames,a=s.Sheets[o[0]],u=[];for(let l in a)if(l.startsWith("B")&&a[l].v===this.groupName){let c=Number(l.slice(1))-2,d=c+27;u.push(`<tr><td colspan="7"><b>${a[`B${c}`].v}</b></td></tr>`);for(let _=c+1;_<=d;_++){let f=`<tr>${["A","B","C","D","E","F","G"].map(h=>a[`${h}${_}`]?`<td><b>${a[`${h}${_}`].v}</b></td>`:"<td></td>").join(" ")}</tr>`;u.push((_-c+1)%4===0?`${f}<tr><td colspan="7" class="line"></td></tr>`:f)}break}let m=u.map(l=>l.replace(/ +/g," ")).join("");return this.setSchedule(m,t),m}};var W=class{constructor(e,t,s){this._duties=s,this.groupName=e,this._users=t}getDuty(e,t){return this._duties.filter(s=>s.date>e&&s.date<t)}insertDuty(e,t,s){this._duties.push({group:this.groupName,date:e,user:t,name:s}),n.connection.query(`INSERT INTO duty (\`group\`,\`date\`,\`user\`,\`name\`) values('${this.groupName}','${e}','${t}','${s}')`)}generateHTML(e){let t=this._users,s=Array(6).fill(null).map(()=>[]),o=Array(6).fill(null).map(()=>[]),a=Array(6).fill(null).map(()=>[]),u=[],p=[],m=[];t.forEach(f=>{f.duty.day!==-1&&s[f.duty.day-1].push(f.info.name)}),t.sort((f,h)=>h.duty.count-f.duty.count).forEach(f=>{f.duty.day!==-1&&a[f.duty.day-1].push(`${f.info.name}-${f.duty.count}`)});let l=new Date(Date.now()-6048e5*e),c=new Date(l.setDate(l.getDate()-l.getDay())),d=new Date(c);d.setDate(c.getDate()+6),this.getDuty(c.getTime(),d.getTime()).forEach(f=>{let h=new Date(f.date).getDay();h!==0&&o[h-1].push(f.name)});for(let f=0;f<5;f++){let h=N=>`<tr>${N.map(v=>`<td><b>${v[f]||""}</b></td>`).join("")}</tr>`;u.push(h(s)),p.push(h(o)),m.push(h(a))}let x=f=>{let h=new Date(c.getTime()+864e5*f);return`${h.getDate()}.${`0${h.getMonth()+1}`.slice(-2)}`};return`
<tr><td colspan="6"><b>\u0414\u0435\u0436\u0443\u0440\u043D\u044B\u0435 \u043F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td></tr>
<tr><td><b>\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A</b></td><td><b>\u0412\u0442\u043E\u0440\u043D\u0438\u043A</b></td><td><b>\u0421\u0440\u0435\u0434\u0430</b></td><td><b>\u0427\u0435\u0442\u0432\u0435\u0440\u0433</b></td><td><b>\u041F\u044F\u0442\u043D\u0438\u0446\u0430</b></td><td><b>\u0421\u0443\u0431\u0431\u043E\u0442\u0430</b></td></tr>
<tr><td colspan="6" class="line"></td></tr>
${u.join("")}
<tr><td colspan="6" class="line"></td></tr>
<tr><td colspan="6"><b>\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438</b></td></tr>
<tr>
${[1,2,3,4,5,6].map(f=>`<td><b>${x(f)}</b></td>`).join("")}
</tr>
<tr><td colspan="6" class="line"></td></tr>
${p.join("")}
<tr><td colspan="6" class="line"></td></tr>
<tr><td colspan="6"><b>\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0435\u0436\u0443\u0440\u0441\u0442\u0432</b></td></tr>
${m.join("")}
`}};var K=class{constructor(e,t,s){this.groupName=e,this.html=t,this.link=s}setReplacement(e,t){this.html=e,this.link=t,n.connection.query(`UPDATE groups SET replacement = '${e}' WHERE name = '${this.groupName}'`)}};var T=class{constructor(){}async load(e,t,s){let o=!t||!s?await _e.groups(e):{schedule:t,replacement:s,name:e};this.name=o.name,this.schedule=new H(this.name,o.schedule,(await new R().load("scheduleLink")).value),this.replacement=new K(this.name,o.replacement,(await new R().load("replacementLink")).value);let a=await _e.duty(e);return this._duty=new W(this.name,this.users,a),this}get users(){return n.users.getGroupUsers(this.name)}get duty(){return this._duty}async sendPhoto(e,t,s,o,a){for(let u of n.users.getGroupUsers(this.name)){let p=u.settings.theme,m=a&&p!=="standard"?await new w(p,a).getImage():e,l=o?await g.groupIsPaid(u):!0;if(u.payment.status!==0&&u.settings[s]==="on"&&l){if(n.devMode&&u.info.id!==6018898378)return;u.sendPhoto(m,t)}}}async setReplacement(e,t){e.unshift(`
<tr><td colspan="8"><b>\u0417\u0410\u041C\u0415\u041D\u042B ${t}</b></td></tr>
<tr><td><b>\u0413\u0440\u0443\u043F\u043F\u0430</b></td><td><b>\u041F\u0430\u0440\u0430</b></td><td colspan="2"><b>\u041F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td><td><b><===></b></td><td colspan="2"><b>\u0417\u0430\u043C\u0435\u043D\u0430</b></td><td><b>\u0410\u0443\u0434\u0438\u0442\u043E\u0440\u0438\u044F</b></td></tr>
<tr><td colspan="8" class="line"></td></tr>`),this.replacement.setReplacement(e.join(""),(await new R().load("replacementLink")).value)}},_e={groups:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM groups WHERE name = ?",[r],(s,o)=>{s?t(new Error("SQL ERROR in Group")):e(o[0])})}),duty:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM duty WHERE `group` = ?",[r],(s,o)=>{s?t(new Error("SQL ERROR in Group Duty")):e(o)})})};var F=class{constructor(){this.all=[]}async load(){let e=await mr.replacements();return this.all=e.reverse(),this}insertReplacement(e,t,s){let o={link:e,date:t,html:s};this.all.unshift(o),n.connection.query("INSERT INTO replacements (link, date, html) VALUES (?, ?, ?)",[e,t,s],u=>{if(u)throw new Error("SQL ERROR in Replacements - insert")})}getReplacement(e){return this.all[e]}},mr={replacements:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM replacements",(s,o)=>{s?e(new Error("SQL ERROR in Replacements - select")):r(o)})})};var Me=require("telegraf");var Re=require("mysql");var xe=M(require("xlsx")),j=class{constructor(){this.all=[];this.map=new Map}async load(){let e=await pr.all();return this.all=await Promise.all(e.map(async t=>{let s=await new T().load(t.name,t.schedule,t.replacement);return this.map.set(t.name,s),s})),this}isGroupInText(e){return e=e.replace(" ","-").toLowerCase(),this.all.find(t=>e.includes(t.name.toLowerCase()))}getGroup(e){return this.map.get(e)}async parseGroups(e){let t=await fetch(e),s=xe.default.read(Buffer.from(await t.clone().arrayBuffer())),o=s.SheetNames,a=s.Sheets[o[0]],u=[];for(let p in a)p.startsWith("B")&&a[p].v.trim().match(/^[А-Я]+-[0-9][0-9]$|^[А-Я]+-[0-9][0-9][а-я]$/ig)&&(this.getGroup(a[p].v.trim())||(await this.setGroup(a[p].v.trim()),u.push(a[p].v.trim())));return`\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u044B \u0433\u0440\u0443\u043F\u043F\u044B: ${u.join(", ")}`}setGroup(e){return new Promise((t,s)=>{n.connection.query("INSERT INTO groups (name) VALUES (?)",[e],async o=>{if(o)return s(new Error("SQL ERROR in setGroup"));try{let a=await new T().load(e,"null");this.map.set(e,a),this.all.push(a),t()}catch(a){s(a)}})})}},pr={all:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM groups",(t,s)=>{t?e(new Error("SQL ERROR in Groups")):r(s)})})};var lr={host:i.SQLHOST,user:i.SQLUSER,database:i.SQLDATABASE,password:i.SQLPASSWORD},z=class extends Me.Telegraf{constructor(){super(i.TOKEN);this.devMode=!1;this.connection=(0,Re.createPool)(lr)}launchBot(){this.launch(),this.sendTemporaryMessage(6018898378,"\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D!"),console.log("\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D")}async loadData(t,s){let o=await t();return await this.sendTemporaryMessage(6018898378,s),console.log(s),o}async addGradients(){this.gradients=await this.loadData(()=>new B().load(),"\u0413\u0440\u0430\u0434\u0438\u0435\u043D\u0442\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addGroups(){this.groups=await this.loadData(()=>new j().load(),"\u0413\u0440\u0443\u043F\u043F\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addUsers(){this.users=await this.loadData(()=>new O().load(),"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addReplacements(){this.replacements=await this.loadData(()=>new F().load(),"\u0417\u0430\u043C\u0435\u043D\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async sendTemporaryMessage(t,s){try{let o=await this.telegram.sendMessage(t,s);setTimeout(()=>{this.telegram.deleteMessage(o.chat.id,o.message_id).catch(console.error)},30*1e3)}catch(o){console.error(o)}}};var E=class{constructor(){this.all=new Map}async load(){let e=await cr.all();return await Promise.all(e.map(async t=>{let s=new R;await s.load(t.type,t),this.all.set(t.type,s)})),this}getSettings(e){return this.all.get(e)}},cr={all:()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM settings",(s,o)=>{s?e(new Error("SQL ERROR in Settings")):r(o)})})};var Ue=M(require("pdf-parse")),Ie=M(require("word-extractor")),dr=new Ie.default,V=class{constructor(e,t){this.replIgnore=["\u0413\u0440\u0443\u043F\u043F\u0430","\u041F\u0410\u0420\u0410","\u041F\u0420\u0415\u041F\u041E\u0414\u0410\u0412\u0410\u0422\u0415\u041B\u042C","\u0417\u0410\u041C\u0415\u041D\u0410","\u0420\u0410\u0421\u041F\u0418\u0421\u0410\u041D\u0418\u042E"];this.buffer=e,this.fileType=t}async getData(){switch(this.fileType){case"doc":return(await dr.extract(this.buffer)).getBody();case"pdf":return(await(0,Ue.default)(this.buffer)).text}}async getReplacementData(){return this.data=await this.getData(),this.data.replace(/\t/g," ").split(`
`).filter(e=>!this.replIgnore.some(t=>e.startsWith(t))&&e.trim()!==""&&e.replace(/\s/g,"")!=="\u041F\u041E")}};var Y=class{constructor(e){this._date=e.date,this.text=e.text,this._link=e.link}get date(){return this._date}get link(){return this._link}async getHtml(){let e=new Date(this._date);return this._html=await this.generateHTML(`${`0${e.getDate()}`.slice(-2)}.${`0${e.getMonth()+1}`.slice(-2)}.${e.getFullYear()}`),this._html}async parseText(){let e=[],t=0;for(;t<this.text.length;){let s=this.text[t];if(s?.match(/ЗАМЕНЫ/g))e.push({text:`${s} ${this.text[t+1]}`,group:null,pair:"null",auditorium:"null"}),t+=2;else{let o=n.groups.isGroupInText(s);if(o){let a=[s],u=1;for(;this.text[t+u]&&!n.groups.isGroupInText(String(this.text[t+u]))&&!this.text[t+u].match(/ЗАМЕНЫ/g);)a.push(this.text[t+u]),u++;let p=a.join(" ").slice(o.name.length+1).replace(/ +/g," "),[m]=p.split(/\. (?=[А-Яа-я0-9(])|\) (?=[А-Яа-я0-9(])/g).reverse(),l=p.match(/[0-9]п([,\-])[0-9]п|[0-9]([,\-])[0-9]п|[0-9]п|[0-9]/),c=l?l[0]:void 0,d=c?p.replace(c,"").replace(m,"").trim():p.trim();e.push({text:d,group:o,pair:c,auditorium:m}),t+=a.length}}}return e}async generateHTML(e){let t=await this.parseText(),s=[],o=new Map,a=(m,l)=>!!(m[l+1]&&m[l+1].startsWith("(")),u=(m,l)=>`<tr><td><b>${m.group?.name||""}</b></td><td><b>${m.pair||""}</b></td>${l}<td><b>${m.auditorium||""}</b></td></tr>`,p=m=>{switch(m.length){case 1:return`<td colspan="2"><b>${m[0]}</b></td><td><b></b></td><td colspan="2"><b></b></td>`;case 2:return`<td colspan="2"><b>${m[0]}</b></td><td><b></b></td><td colspan="2"><b>${m[1]}</b></td>`;case 3:return`<td colspan="2"><b>${m[0]}</b></td><td><b>${m[1]}</b></td><td colspan="2"><b>${m[2]}</b></td>`;case 4:return`<td><b>${m[0]}</b></td><td><b>${m[1]}</b></td><td></td><td><b>${m[2]}</b></td><td><b>${m[3]}</b></td>`;default:return`<td colspan="5"><b>${m.join(" ")}</b></td>`}};for(let m of t)if(!m.group)s.push(`<tr><td colspan="8"><b>${m.text}</b></td></tr>`,'<tr><td><b>\u0413\u0440\u0443\u043F\u043F\u0430</b></td><td><b>\u041F\u0430\u0440\u0430</b></td><td colspan="2"><b>\u041F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td><td><b><===></b></td><td colspan="2"><b>\u0417\u0430\u043C\u0435\u043D\u0430</b></td><td><b>\u0410\u0443\u0434\u0438\u0442\u043E\u0440\u0438\u044F</b></td></tr>','<tr><td colspan="8" class="line"></td></tr>');else{let l=m.text.replace(/ +/g," ").match(/[А-Я][а-я]+ [А-Я].[А-Я].|\([а-я]+\)|\([А-Яа-я0-9 .]+ +[А-Яа-я0-9 .]+\)|[А-Яа-я0-9]+/g)||[],c=[],d=0;for(;d<l.length;)if(a(l,d)){let N=[l[d],`
${l[d+1]}`],v=2;for(;a(l,d+v);)N.push(`
${l[d+v]}`),v++;d+=v,c.push(N.join(" "))}else c.push(l[d]),d++;let _=p(c),f=t[t.indexOf(m)+1]?.group===null,h=u(m,_);s.push(h),o.has(m.group.name)?o.get(m.group.name)?.push(h):o.set(m.group.name,[h]),f&&s.push('<tr><td colspan="8" class="line"></td></tr>')}return n.groups.all.forEach(m=>{if(o.has(m.name)){let l=o.get(m.name);l&&m.setReplacement(l,e)}else{let l=['<tr><td colspan="8"><b>\u0417\u0430\u043C\u0435\u043D\u044B \u0434\u043B\u044F \u0432\u0430\u0448\u0435\u0439 \u0433\u0440\u0443\u043F\u043F\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B</b></td></tr>'];m.setReplacement(l,e)}}),s.join("")}};var X=require("telegraf"),Z=async r=>[[X.Markup.button.callback(`\u0414\u0435\u0436\u0443\u0440\u0441\u0442\u0432\u0430: ${r.settings.duty}`,`settingsDuty${r.info.id}`),X.Markup.button.callback(`\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${r.settings.schedule}`,`settingsSchedule${r.info.id}`),X.Markup.button.callback(`\u0417\u0430\u043C\u0435\u043D\u044B: ${r.settings.replacement}`,`settingsReplacement${r.info.id}`)]];var ve=async(r,e,t)=>{let s=Number(e.replace(/^\D+/g,"")),o=n.users.getUser(s);if(!o){await r.reply(i.notfoundMessages.user);return}switch(t){case"duty":o.settings.switchDuty();break;case"schedule":o.settings.switchSchedule();break;case"replacement":o.settings.switchReplacement();break}await r.editMessageText("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438:",{reply_markup:{inline_keyboard:await Z(o)}})};var Ee=async(r,e)=>{let t=parseInt(e.slice(10),10),s=n.users.getUser(t);if(!s){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}s.sendText("\u041E\u0448\u0438\u0431\u043A\u0430. \u0412\u044B \u043D\u0435 \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443!");let o=r.callbackQuery?.message?.message_id,a=r.callbackQuery?.from.id;o&&a&&await n.telegram.deleteMessage(a,o)};var $e=async(r,e)=>{let t=r.from?.id,s=parseInt(e.slice(10),10),o=new Map([[1,"\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A"],[2,"\u0412\u0442\u043E\u0440\u043D\u0438\u043A"],[3,"\u0421\u0440\u0435\u0434\u0430"],[4,"\u0427\u0435\u0442\u0432\u0435\u0440\u0433"],[5,"\u041F\u044F\u0442\u043D\u0438\u0446\u0430"],[6,"\u0421\u0443\u0431\u0431\u043E\u0442\u0430"]]);if(!t)return;let a=n.users.getUser(t);if(!a){await r.reply(i.notfoundMessages.user);return}a.duty.day=s,await r.editMessageText(`\u0423\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D \u0434\u0435\u043D\u044C: ${o.get(s)}`)};var De=async(r,e)=>{let t=r.from?.id,s=e.slice(8);if(!t)return;let o=n.users.getUser(t);if(!o){await r.reply(i.notfoundMessages.user);return}o.info.groupName=s,await r.editMessageText(`\u0423\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0433\u0440\u0443\u043F\u043F\u0430: ${s}`)};var ke=require("telegraf");var $=async(r,e)=>{let s=[{label:"true",value:`userStatus_2___${e.info.id}`},{label:"false",value:`userStatus_1___${e.info.id}`},{label:"free",value:`userStatus_f___${e.info.id}`},{label:"vip",value:`userStatus_vip_${e.info.id}`},{label:"ban",value:`userStatus_0___${e.info.id}`},{label:"\u21A9\uFE0F",value:"userStatus_undo"}].map(o=>ke.Markup.button.callback(o.label,o.value));await r.editMessageText(`\u0422\u0435\u043A\u0443\u0449\u0438\u0439 \u0441\u0442\u0430\u0442\u0443\u0441: ${i.payment.get(e.payment.status)}
\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u043D\u0430:`,{reply_markup:{inline_keyboard:[s]}})};var Te=require("telegraf");var Pe=async(r,e)=>{let t=Number(e.split("_").pop()),s=n.users.getUser(t),o=[{label:"2\u043C\u0435\u0441",value:`vipStatus_3_${t}`},{label:"3\u043C\u0435\u0441",value:`vipStatus_4_${t}`},{label:"4\u043C\u0435\u0441",value:`vipStatus_5_${t}`},{label:"5\u043C\u0435\u0441",value:`vipStatus_6_${t}`},{label:"6\u043C\u0435\u0441",value:`vipStatus_7_${t}`},{label:"\u21A9\uFE0F",value:"userStatus_undo"}];if(e.includes("vip")){let a=o.map(u=>Te.Markup.button.callback(u.label,u.value));await r.editMessageText("\u0423\u0440\u043E\u0432\u0435\u043D\u044C VIP:",{reply_markup:{inline_keyboard:[a]}})}else if(e.includes("undo")){let a=await g.generateUsersKeyboard();await r.editMessageText("\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u043B\u044F:",{reply_markup:{inline_keyboard:a}})}else if(s){let a=e.slice(11).startsWith("f")?-1:Number(e.charAt(11));s.payment.status=a,s.payment.paid="true",await $(r,s);let u=a===0?"\u0412\u044B \u0431\u044B\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C":i.paymentMessages.changeStatus(a);s.sendText(u)}else await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D")};var Ne=async(r,e)=>{let t=e.split("_"),s=parseInt(t[1],10),o=parseInt(t[2],10),a=n.users.getUser(o);if(!a){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}a.payment.status=s,a.payment.paid="true",await $(r,a);let u=i.paymentMessages.changeStatus(s);a.sendText(u)};var qe=async()=>{let r=n.gradients.light;for(let e of n.groups.all){let t=e.duty.generateHTML(0),s=await new w(r,t).getImage();await e.sendPhoto(s,"duty.png","duty",!0,t)}};var Ce=async(r,e)=>{try{let t=await fetch(r);if(!t.ok){console.log(`Failed to fetch: ${t.statusText}`),await n.telegram.sendMessage(6018898378,"\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B");return}let s=Buffer.from(await t.arrayBuffer()),o=r.slice(-3),a=new Date(`${e.slice(-4)}-${e.slice(3,5)}-${e.slice(0,2)}`).getTime(),u=new Y({date:a,text:await new V(s,o).getReplacementData(),link:r}),p=n.replacements.getReplacement(0),m=await u.getHtml();if(m!==p?.html){n.replacements.insertReplacement(u.link,u.date,m);let l=n.gradients.dark,c=await new w(l,m).getImage();await n.users.sendPhoto(c,"replacement.png","replacement",!0,m)}}catch(t){console.log(`Error during processing: ${t}`),await n.telegram.sendMessage(6018898378,"\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B")}};var Le=async r=>{try{let e=await fetch(r);if(!e.ok){await n.telegram.sendMessage(6018898378,"\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E");return}let t=n.groups.all;for(let s of t)if(s.users.length>0){await s.schedule.generateSchedule(e,r);let{html:o}=s.schedule;if(o&&o!=="null")try{let a=n.gradients.light,u=await new w(a,o).getImage();await s.sendPhoto(u,"schedule.png","schedule",!0,o)}catch(a){console.log(`Error while sending photo for group ${s.name}: ${a}`)}}}catch(e){console.log(`Error during processing: ${e}`),await n.telegram.sendMessage(6018898378,"\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E")}};var D={duty:qe,replacement:Ce,schedule:Le};var Ge=async(r,e)=>{let t=Number(r.slice(17)),s=n.users.getUser(e);if(!s)return;let a=(await new E().load()).getSettings("replacementLink"),u=await(await fetch(i.fetchUrl)).text(),p=/<strong>[А-Яа-я0-9. ]+/g,m=u.match(p),l=new Date().getFullYear(),c=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+l+'[0-9/.\\-A-Za-z_]+"',"g"),d=Array.from(new Set(u.match(c))).map(x=>x.slice(9,-1));if(!m){s.sendText("DateArr not found");return}let _=m.map(x=>x.match(/[0-9]+.[0-9]+.[0-9]+/g)?.[0]).filter(Boolean);a&&d[t]!==a.value?(a.value=d[t],s.sendAutoDeleteText(`\u0417\u0430\u043C\u0435\u043D\u044B: ${_[1]} ${d[t].slice(36)}`,1e3*30),await D.replacement(d[t],_[1])):s.sendAutoDeleteText("\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B",1e3*30)};var Ae=async(r,e)=>{let t=Number(r.slice(14)),s=n.users.getUser(e);if(!s)return;let a=(await new E().load()).getSettings("scheduleLink"),u=await(await fetch(i.fetchUrl)).text(),p=/<strong>[А-Яа-я0-9. ]+/g,m=u.match(p),l=new Date().getFullYear(),c=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+l+'[0-9/.\\-A-Za-z_]+"',"g"),d=Array.from(new Set(u.match(c))).map(x=>x.slice(9,-1));if(!m){s.sendText("DateArr not found");return}let _=m.map(x=>x.match(/[0-9]+.[0-9]+.[0-9]+/g)?.[0]).filter(Boolean);a&&d[t]!==a.value?(a.value=d[t],s.sendAutoDeleteText(`\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${_[0]} ${d[t].slice(36)}`,1e3*30),await D.schedule(d[t])):s.sendAutoDeleteText("\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E",1e3*30)};var S={paidStatus:Ee,setDutyDay:$e,setGroup:De,userPaid:$,userStatus:Pe,vipStatus:Ne,settings:{keyboard:Z,updateSettings:ve},fetch:{replacement:Ge,schedule:Ae}};var Qe=()=>{n.on("callback_query",async r=>{let e=r.callbackQuery?.data;if(e)if(e.startsWith("userPaid")){let t=Number(e.slice(8)),s=n.users.getUser(t);if(!s){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}await S.userPaid(r,s)}else e.startsWith("paidStatus")?await S.paidStatus(r,e):e.startsWith("userStatus")?await S.userStatus(r,e):e.startsWith("vipStatus")?await S.vipStatus(r,e):e.startsWith("settings")?await S.settings.updateSettings(r,e,e.slice(8).toLowerCase().replace(/[0-9]+/g,"")):e.startsWith("setGroup")?await S.setGroup(r,e):e.startsWith("setDutyDay")?await S.setDutyDay(r,e):e.startsWith("fetch")&&(e.startsWith("fetchSchedules")?(await S.fetch.schedule(e,r.from.id),await r.deleteMessage()):e.startsWith("fetchReplacements")&&(await S.fetch.replacement(e,r.from.id),await r.deleteMessage()))})};async function Oe(r){if(!r.chat?.id||!r.from?.username)return;let e=r.chat.id,t=r.from.username;n.users.getUser(e)||(await n.users.createUser(e,t,2,t,await fr(e)),await n.telegram.sendMessage(6018898378,`${e} ${t}, \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0438\u043B\u0441\u044F \u043A \u0431\u043E\u0442\u0443`)),await r.reply(`\u0412\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043B\u0438 \u0431\u043E\u0442\u0430!
\u0414\u043B\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E\u0439 \u0440\u0430\u0431\u043E\u0442\u044B \u043F\u0440\u043E\u043F\u0438\u0448\u0438\u0442\u0435 (/setname \u0432\u0430\u0448\u0430 \u0444\u0430\u043C\u0438\u043B\u0438\u044F) \u0438 (/setgroup).
\u0412\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0432\u0432\u0435\u0441\u0442\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447 \u043A\u043E\u043C\u0430\u043D\u0434\u043E\u0439 (/referral \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447), \u0432\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u0435 \u0434\u043E\u0441\u0442\u0443\u043F \u043A\u043E \u0432\u0441\u0435\u043C \u0444\u0443\u043D\u043A\u0446\u0438\u044F\u043C \u043D\u0430 \u043C\u0435\u0441\u044F\u0446 \u0431\u0435\u0441\u043F\u043B\u0430\u0442\u043D\u043E (\u0434\u043E 1-\u0433\u043E \u0447\u0438\u0441\u043B\u0430 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u0433\u043E \u043C\u0435\u0441\u044F\u0446\u0430)`)}async function fr(r){return r<0?"null":r.toString().split("").map(Number).map(e=>(e||10)+64).map(e=>String.fromCharCode(e)).join("")}async function Be(r){let e=r.chat?.id,t=r.text?.slice(6).trim();if(e!==6018898378||!t||t.startsWith("monica_schedule_bot")){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}n.users.sendText(t)}async function He(r){await r.reply("\u041D\u0435 \u0443\u0434\u0430\u043B\u044F\u0439\u0442\u0435 \u044D\u0442\u043E \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435!",{reply_markup:{resize_keyboard:!0,keyboard:[["\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B"]]}})}async function We(r,e){if(r!==6018898378){e&&await e.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let t=n.users.getUser(r);if(!t)return;let s=await(await fetch(i.fetchUrl)).text(),o=new Date().getFullYear(),a=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+o+'[0-9/.\\-A-Za-z_]+"',"g"),u=Array.from(new Set(s.match(a))).map(l=>l.slice(9,-1)),p=u.map((l,c)=>[{text:l.slice(36),callback_data:`fetchReplacements${c}`}]),m=u.map((l,c)=>[{text:l.slice(36),callback_data:`fetchSchedules${c}`}]);t.sendButtons("\u0414\u043E\u0441\u0442\u0443\u043F\u043D\u044B \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0435 url \u0434\u043B\u044F \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044F:",m),t.sendButtons("\u0414\u043E\u0441\u0442\u0443\u043F\u043D\u044B \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0438\u0435 url \u0434\u043B\u044F \u0437\u0430\u043C\u0435\u043D:",p)}async function Ke(r){let e=r.chat?.id;if(!e){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430: \u0447\u0430\u0442 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}let t=n.users.getUser(e);if(!t){await r.reply(i.notfoundMessages.user);return}if(t.info.id<=0){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430. \u041A\u043E\u043C\u0430\u043D\u0434\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0438\u0437 \u0433\u0440\u0443\u043F\u043F\u044B");return}let s=`${t.info.name}(${t.info.id}) \u043E\u043F\u043E\u0432\u0435\u0441\u0442\u0438\u043B \u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u0435, \u0441\u0442\u0430\u0442\u0443\u0441: ${i.payment.get(t.payment.status)}`,o={inline_keyboard:[[{text:"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D\u043E",callback_data:`paidStatus${t.info.id}`},{text:"\u041E\u043F\u043B\u0430\u0447\u0435\u043D\u043E",callback_data:`userPaid${t.info.id}`}]]};await n.telegram.sendMessage(6018898378,s,{reply_markup:o}),await r.reply("\u0417\u0430\u043F\u0440\u043E\u0441 \u043D\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u043E\u043F\u043B\u0430\u0442\u044B \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D, \u043E\u0436\u0438\u0434\u0430\u0439\u0442\u0435")}async function Fe(r){let e=r.chat?.id;if(!e)return;let t=n.users.getUser(e);if(!t){await r.reply(i.notfoundMessages.user);return}let{groupName:s,id:o,name:a}=t.info,u=t.payment.referral.key,p=i.paymentMessages.refBonus(t.info.id,t.payment.referral.agentsApprove),m=i.payment.get(t.payment.status),l=Math.floor(t.payment.price-t.payment.price*(p/100)),c=`
        \u0413\u0440\u0443\u043F\u043F\u0430: <b>${s}</b>
        Id: \u{1F517}<code>${o}</code>
        \u0424\u0430\u043C\u0438\u043B\u0438\u044F: <b>${a}</b>
        \u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u043F\u043B\u0430\u0442\u044B: <b>${m}</b>
        \u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u0441 \u0443\u0447\u0435\u0442\u043E\u043C \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043A\u0438: <b>${l}</b>
        \u0420\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447: \u{1F517}<code>${u}</code>
        \u0411\u043E\u043D\u0443\u0441 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043E\u0432: <b>${p}%</b>
        \u0421\u0432\u044F\u0437\u044C \u0441 \u0430\u0434\u043C\u0438\u043D\u043E\u043C: @a_korop
    `.replace(/\n +/g,`
`);await r.reply(c,{parse_mode:"HTML"})}async function je(r){let e=r.chat?.id,t=r.text?.slice(10).trim();if(!e)return;let s=n.users.getUser(e);if(!s){await r.reply(i.notfoundMessages.user);return}if(!t){await r.reply("\u0412\u044B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043B\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447(/referral \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447)");return}let o=await g.setReferralKey(s,t);await r.reply(o)}async function ze(r){let e=r.chat?.id;if(!e)return;let t=n.users.getUser(e);if(!t){await r.reply(i.notfoundMessages.user);return}if(t.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B");return}if(!await g.groupIsPaid(t)){await r.reply("\u041D\u0435 \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u0433\u0440\u0443\u043F\u043F\u044B \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443");return}let o=n.replacements.getReplacement(0);if(!o){await r.reply("\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B");return}let a=t.settings.theme==="standard"?n.gradients.dark:`background-image: url(${t.settings.theme});`,u=await new w(a,o.html).getImage();t.sendPhoto(u,"schedule.png")}async function Ve(r){r.chat?.id===6018898378?(await r.reply("\u0411\u043E\u0442 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D!"),setTimeout(()=>{process.exit(0)},1e3*30)):await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412")}async function Ye(r){let e=r.chat?.id;if(!e)return;let t=n.users.getUser(e);if(!t){await r.reply(i.notfoundMessages.user);return}if(t.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B");return}let s=n.groups.getGroup(t.info.groupName);if(t.info.groupName==="null"||!s){await r.reply(i.notfoundMessages.group);return}let o=s.schedule.html;if(o==="null"){await r.reply("\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E");return}if(!await g.groupIsPaid(t)){await r.reply("\u041D\u0435 \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u0433\u0440\u0443\u043F\u043F\u044B \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443");return}let u=t.settings.theme==="standard"?n.gradients.light:`background-image: url(${t.settings.theme});`,p=await new w(u,o).getImage();t.sendPhoto(p,"schedule.png")}async function Xe(r){let e=r.chat?.id;if(!e)return;if(n.users.getUser(e)){n.groups.all.sort((o,a)=>o.name.localeCompare(a.name));let s=[];n.groups.all.forEach((o,a)=>{let u=Math.floor(a/5);s[u]||(s[u]=[]),s[u].push({text:o.name,callback_data:`setGroup${o.name}`})}),await r.reply("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443:",{reply_markup:{inline_keyboard:s}})}else await r.reply(i.notfoundMessages.user)}async function Ze(r){if(!r.chat?.id)return;let e=n.users.getUser(r.chat.id);if(!e){await r.reply(i.notfoundMessages.user);return}let t=r.text?.slice(9);t?(e.info.name=t,await r.reply(`\u0412\u0430\u0448\u0435 \u0438\u043C\u044F - ${t}`)):await r.reply("\u0412\u044B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043B\u0438 \u0438\u043C\u044F (/setname \u0432\u0430\u0448\u0435 \u0438\u043C\u044F)")}async function Je(r){if(!r.chat?.id)return;let e=n.users.getUser(r.chat.id);if(!e){await r.reply(i.notfoundMessages.user);return}let t=await S.settings.keyboard(e);await r.reply("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438:",{reply_markup:{inline_keyboard:t}})}async function et(r){if(r.chat?.id!==6018898378){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let e=await g.generateUsersKeyboard();await r.reply("\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u043B\u044F:",{reply_markup:{inline_keyboard:e}})}async function tt(r){if(!r.chat?.id)return;let e=n.users.getUser(r.chat.id);if(!e){await r.reply(i.notfoundMessages.user);return}if(e.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C");return}let t=r.text?.slice(7);if(!t||t.startsWith("monica_schedule_bot")){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430,\u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443, \u043A\u043E\u043C\u0430\u043D\u0434\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0438\u0437 \u0433\u0440\u0443\u043F\u043F\u044B \u0438\u043B\u0438 \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0435 \u0432\u0435\u0434\u0435\u0442 \u043D\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443");return}e.settings.theme=t,await r.reply(`\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0442\u0435\u043C\u0430: ${e.settings.theme}`)}async function rt(r){let e=r.chat?.id;if(!e)return;if(!n.users.getUser(e)){await r.reply(i.notfoundMessages.user);return}let o=[{name:"\u041F\u043D\u0434",value:1},{name:"\u0412\u0442\u0440",value:2},{name:"\u0421\u0440\u0434",value:3},{name:"\u0427\u0442\u0432",value:4},{name:"\u041F\u0442\u043D",value:5},{name:"\u0421\u0431\u0442",value:6}].map(a=>({text:a.name,callback_data:`setDutyDay${a.value}`}));await r.reply("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0434\u0435\u043D\u044C:",{reply_markup:{inline_keyboard:[o]}})}async function st(r){if(r.from?.id!==6018898378){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let e=await(await fetch(i.fetchUrl)).text(),t=new Date().getFullYear(),s=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+t+'[0-9/.\\-A-Za-z_]+"',"g"),o=Array.from(new Set(e.match(s))).map(u=>u.slice(9,-1)),a=await n.groups.parseGroups(o[0]);await r.reply(a)}var b={start:Oe,send:Be,duty:He,fetch:We,paid:Ke,profile:Fe,referral:je,replacement:ze,restart:Ve,schedule:Ye,setGroup:Xe,setName:Ze,settings:Je,status:et,theme:tt,setDutyDay:rt,parseGroups:st};var gr={start:b.start,fetch:r=>b.fetch(r.chat.id,r),send:b.send,schedule:b.schedule,theme:b.theme,status:b.status,settings:b.settings,profile:b.profile,setname:b.setName,setgroup:b.setGroup,referral:b.referral,paid:b.paid,replacement:b.replacement,restart:b.restart,duty:b.duty,setdutydate:b.setDutyDay,parsegroups:b.parseGroups},nt=()=>{Object.entries(gr).forEach(([r,e])=>{n.command(r,async t=>{await e(t)})})};var ot=require("cron");var U=(r,e)=>{new ot.CronJob(r,async()=>{try{await e()}catch(t){console.error(t)}},null,!0)},at=()=>{U("0 0 10 * * *",()=>P()),U("0 0 12 * * *",()=>P()),U("0 0 14 * * *",()=>P()),U("0 0 16 * * *",()=>P()),U("0 0 18 * * *",()=>P()),U("0 0 13 1 * *",g.recount),U("0 35 7 25-31 * *",g.preAlert),U("0 0 20 * * 6",D.duty)},P=async()=>{await S.fetch.schedule("fetchSchedules0",6018898378),await S.fetch.replacement("fetchReplacements2",6018898378)};var At=M(require("express")),Qt=M(require("cors")),Ot=M(require("http"));var it=async r=>({table:n.replacements.getReplacement(r)?.html??"null"});var ut=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};let t=n.groups.getGroup(e.info.groupName);return t?{table:t.replacement.html!=="null"?t.replacement.html:"<tr><td><b>\u0417\u0430\u043C\u0435\u043D\u044B \u0434\u043B\u044F \u0432\u0430\u0448\u0435\u0439 \u0433\u0440\u0443\u043F\u043F\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B!</b></td></tr>"}:{table:i.notfoundMessagesSite.group}};var mt={table:it,groupTable:ut};var pt=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};let t=n.groups.getGroup(e.info.groupName);return t?{table:t.schedule.html!=="null"?t.schedule.html:"<tr><td><b>\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E!</b></td></tr>"}:{table:i.notfoundMessagesSite.group}};var lt=r=>{let e=n.groups.getGroup(r);return e?{table:e.schedule.html!=="null"?e.schedule.html:"<tr><td><b>\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E!</b></td></tr>"}:{table:i.notfoundMessagesSite.group}};var ct=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};let t=[],s=[];for(let o of n.groups.all.values())o.name===e.info.groupName?t.push(`<option selected value='${o.name}'>${o.name}</option>`):o.schedule.html==="null"?s.push(`<option disabled value='${o.name}'>${o.name}</option>`):t.push(`<option value='${o.name}'>${o.name}</option>`);return{table:t.concat(s).join("")}};var dt={table:pt,update:lt,select:ct};var ft={replacement:mt,schedule:dt};var gt=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:i.notfoundMessagesSite.user};let s=n.groups.getGroup(t.info.groupName);return s?{table:s.duty.generateHTML(e)}:{table:i.notfoundMessagesSite.group}};var yt=r=>{let e=n.users.getUser(r);if(!e)return{alert:i.notfoundMessagesSite.user};let t=n.groups.getGroup(e.info.groupName);if(!t)return{alert:i.notfoundMessagesSite.group};let s=Date.now(),o=new Date().getDay();if(o!==0&&e.payment.status!==0&&e.duty.lastDate+432e5<=s){t.duty.insertDuty(s,e.info.id,e.info.name),e.duty.count+=1,e.duty.lastDate=s;let a=t.users.filter(u=>(u.info.role==="admin"||u.duty.day===o)&&u.info.groupName===e.info.groupName);for(let u of a)n.devMode&&u.info.id!==6018898378||u.sendText(`${e.info.name} \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B, \u0435\u0441\u043B\u0438 \u043D\u0435\u0442 \u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443`);return{alert:"\u0423\u0441\u043F\u0435\u0448\u043D\u043E!"}}else return{alert:"\u0421\u0435\u0433\u043E\u0434\u043D\u044F \u0432\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435, \u0432\u044B \u0443\u0436\u0435 \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438 \u0438\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B"}};var ht={table:gt,checkin:yt};var bt=(r,e)=>{let t=n.users.getUser(r);if(!t)return i.notfoundMessagesSite.user;let s=Math.floor(i.paymentMessages.cost(t.info.id,t.payment.price,t.payment.referral.agentsApprove)+(e-1)*t.payment.price);return`\u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u043D\u0430 ${e} \u043C\u0435\u0441\u044F\u0446\u0435\u0432: ${s}`};var wt=async(r,e)=>{let t=n.users.getUser(r);return t?g.setReferralKey(t,e):i.notfoundMessagesSite.user};var St=r=>{let e=n.users.getUser(r);if(!e)return;let t=i.paymentMessages.refBonus(e.info.id,e.payment.referral.agentsApprove),s=new Map([[1,"\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A"],[2,"\u0412\u0442\u043E\u0440\u043D\u0438\u043A"],[3,"\u0421\u0440\u0435\u0434\u0430"],[4,"\u0427\u0435\u0442\u0432\u0435\u0440\u0433"],[5,"\u041F\u044F\u0442\u043D\u0438\u0446\u0430"],[6,"\u0421\u0443\u0431\u0431\u043E\u0442\u0430"],[-1,"\u041D\u0435 \u0437\u0430\u0434\u0430\u043D\u043E"]]),o=Array.from(n.groups.all.values()).map(p=>`<option value='${p.name}' ${p.name===e.info.groupName?"selected":""}>${p.name}</option>`).join(""),a=Array.from(s.entries()).map(([p,m])=>`<option value='${p}' ${p===e.duty.day?"selected":""}>${m}</option>`).join(""),u=Math.floor(e.payment.price-e.payment.price*(t/100));return{name:e.info.name,groupName:e.info.groupName,duty:s.get(e.duty.day),payment:i.payment.get(e.payment.status),refKey:e.payment.referral.key,refBonus:String(t),paymentAmount:String(u),groupOptions:o,dutyDayOptions:a}};var _t={monthPay:bt,refKey:wt,table:St};var xt={};var Mt=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:i.notfoundMessagesSite.user};t.duty.day=e};var Rt=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:i.notfoundMessagesSite.user};t.info.groupName=e};var Ut=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:i.notfoundMessagesSite.user};t.info.name=e};var It={dutyDay:Mt,group:Rt,name:Ut};var vt={info:_t,referrals:xt,settings:It};var Et=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};e.settings.switchDuty()};var $t=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};e.settings.switchReplacement()};var Dt=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};e.settings.switchSchedule()};var kt=r=>{let e=n.users.getUser(r);if(e)return{duty:e.settings.duty,schedule:e.settings.schedule,replacement:e.settings.replacement}};var Tt={duty:Et,replacement:$t,schedule:Dt,table:kt};var Pt=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:i.notfoundMessagesSite.user};t.settings.theme=e};var Nt=r=>{let e=n.users.getUser(r);if(!e)return{table:i.notfoundMessagesSite.user};e.settings.switchLightMode()};var qt=r=>{let e=n.users.getUser(r);if(e)return{lightMode:e.settings.lightMode}};var Ct={background:Pt,lightMode:Nt,table:qt};var Lt={notifications:Tt,theme:Ct};var Gt=r=>{let e=n.users.getUser(r);if(!e)return{gradient:n.gradients.light.slice(11,-1)};let{theme:t,lightMode:s}=e.settings,o=s===0?n.gradients.light:n.gradients.dark;return{gradient:t==="standard"?o.slice(11,-1):`url(${t})`}};var y={home:ft,duty:ht,profile:vt,settings:Lt,gradient:Gt};var Bt=()=>{let r=(0,At.default)();r.use((0,Qt.default)()),r.get("/home/schedule/table",async(t,s)=>{s.send(y.home.schedule.table(Number(t.query.user)))}),r.get("/home/schedule/select",async(t,s)=>{s.send(y.home.schedule.select(Number(t.query.user)))}),r.get("/home/schedule/update",async(t,s)=>{s.send(y.home.schedule.update(String(t.query.group)))}),r.get("/home/replacement/table",async(t,s)=>{s.send(await y.home.replacement.table(Number(t.query.page)))}),r.get("/home/replacement/groupTable",async(t,s)=>{s.send(y.home.replacement.groupTable(Number(t.query.user)))}),r.get("/duty/table",async(t,s)=>{s.send(y.duty.table(Number(t.query.user),Number(t.query.page)))}),r.get("/duty/checkin",async(t,s)=>{s.send(y.duty.checkin(Number(t.query.user)))}),r.get("/profile/info/table",async(t,s)=>{s.send(y.profile.info.table(Number(t.query.user)))}),r.get("/profile/settings/group",async(t,s)=>{y.profile.settings.group(Number(t.query.user),String(t.query.group)),s.send()}),r.get("/profile/settings/dutyDay",async(t,s)=>{y.profile.settings.dutyDay(Number(t.query.user),Number(t.query.day)),s.send()}),r.get("/profile/settings/name",async(t,s)=>{y.profile.settings.name(Number(t.query.user),String(t.query.name)),s.send()}),r.get("/profile/info/refKey",async(t,s)=>{let o=await y.profile.info.refKey(Number(t.query.user),String(t.query.refKey));s.send({alert:o})}),r.get("/profile/info/monthPay",async(t,s)=>{let o=y.profile.info.monthPay(Number(t.query.user),Number(t.query.months));s.send({alert:o})}),r.get("/settings/notifications/table",async(t,s)=>{s.send(y.settings.notifications.table(Number(t.query.user)))}),r.get("/settings/notifications/schedule",async(t,s)=>{y.settings.notifications.schedule(Number(t.query.user)),s.send()}),r.get("/settings/notifications/replacement",async(t,s)=>{y.settings.notifications.replacement(Number(t.query.user)),s.send()}),r.get("/settings/notifications/duty",async(t,s)=>{y.settings.notifications.duty(Number(t.query.user)),s.send()}),r.get("/settings/theme/table",async(t,s)=>{s.send(y.settings.theme.table(Number(t.query.user)))}),r.post("/settings/theme/background",async(t,s)=>{y.settings.theme.background(Number(t.query.user),String(t.query.url)),s.send()}),r.post("/settings/theme/lightMode",async(t,s)=>{y.settings.theme.lightMode(Number(t.query.user)),s.send()}),r.get("/gradient",async(t,s)=>{s.send(y.gradient(Number(t.query.user)))}),Ot.default.createServer(r).listen(5e3,n.devMode?"localhost":"104.249.40.163")};var Ht=async r=>{let e=r.chat?.id;if(e)try{let t=n.users.getUser(e),s=Date.now(),o=new Date().getDay();if(!t){await r.reply(i.notfoundMessages.user);return}if(o!==0&&t.payment.status!==0&&t.duty.lastDate+432e5<=s){let a=n.groups.getGroup(t.info.groupName);if(!a){await r.reply(i.notfoundMessages.group);return}a.duty.insertDuty(s,t.info.id,t.info.name),t.duty.count+=1,t.duty.lastDate=s;let u=a.users.filter(p=>(p.info.role==="admin"||p.duty.day===o)&&p.info.groupName===t.info.groupName);for(let p of u)p.sendText(`${t.info.name} \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B, \u0435\u0441\u043B\u0438 \u043D\u0435\u0442 \u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443`);await r.reply("\u0423\u0441\u043F\u0435\u0448\u043D\u043E")}else await r.reply("\u0421\u0435\u0433\u043E\u0434\u043D\u044F \u0432\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435, \u0432\u044B \u0443\u0436\u0435 \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438 \u0438\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B")}catch(t){console.log(`Error processing duty: ${t}`),await n.telegram.sendMessage(e,"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435 \u0432\u0430\u0448\u0435\u0433\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u0430.")}};var Wt={duty:Ht};var Kt=()=>{n.hears("\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B",async r=>{await Wt.duty(r)})};var k={CallbackQueryHandler:Qe,CommandsHandler:nt,CronHandler:at,WebHandler:Bt,HearsHandler:Kt};var n=new z;(async()=>(console.log("\u0414\u0435\u0432 \u043C\u043E\u0434: ",n.devMode),await n.addGradients(),await n.addUsers(),await n.addGroups(),await n.addReplacements(),k.WebHandler(),k.CommandsHandler(),k.CallbackQueryHandler(),k.HearsHandler(),k.CronHandler(),n.launchBot()))();0&&(module.exports={bot});
