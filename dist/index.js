"use strict";var Qt=Object.create;var $=Object.defineProperty;var Ht=Object.getOwnPropertyDescriptor;var Bt=Object.getOwnPropertyNames;var Wt=Object.getPrototypeOf,Ft=Object.prototype.hasOwnProperty;var Kt=(r,e)=>{for(var t in e)$(r,t,{get:e[t],enumerable:!0})},V=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Bt(e))!Ft.call(r,o)&&o!==t&&$(r,o,{get:()=>e[o],enumerable:!(s=Ht(e,o))||s.enumerable});return r};var M=(r,e,t)=>(t=r!=null?Qt(Wt(r)):{},V(e||!r||!r.__esModule?$(t,"default",{value:r,enumerable:!0}):t,r)),jt=r=>V($({},"__esModule",{value:!0}),r);var lr={};Kt(lr,{bot:()=>n});module.exports=jt(lr);var I=class{constructor(e,t,s){e&&t&&s!==void 0&&(this.type=e,this._value=t,this._number=s)}async load(e,t){if(t)this.type=e,this._value=t.value,this._number=t.number;else{let s=await zt.settings(e);this.type=s.type,this._value=s.value,this._number=s.number}return this}get value(){return this._value}set value(e){this._value=e,this.updateSetting("value",e)}get number(){return this._number}set number(e){this._number=e,this.updateSetting("number",e)}updateSetting(e,t){let s=`UPDATE settings SET ${e} = ? WHERE type = ?`;n.connection.query(s,[t,this.type],o=>{if(o)throw new Error("SQL ERROR in Settings - update")})}},zt={settings:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM settings WHERE type = ?",[r],(o,a)=>{o?t(new Error("SQL ERROR in Settings - select")):a.length>0?e(a[0]):t(new Error("No settings found for the given type"))})})};var D=class{constructor(e,t,s,o,a,i){this._bots=e,this._groupName=t,this._id=s,this._name=o,this._role=i,this._userName=a}get bots(){return this._bots}get groupName(){return this._groupName}get id(){return this._id}get name(){return this._name}get role(){return this._role}get userName(){return this._userName}set groupName(e){this._groupName=e,this.updateField("groupName",e)}set name(e){this._name=e,this.updateField("name",e)}set userName(e){this._userName=e,this.updateField("userName",e)}updateField(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this._id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var k=class{constructor(e,t,s,o){this.id=e,this._count=t,this._day=s,this._lastDate=o}get count(){return this._count}get day(){return this._day}get lastDate(){return this._lastDate}set count(e){this._count=e,this.updateDatabase("dutyCount",e)}set day(e){this._day=e,this.updateDatabase("dutyDay",e)}set lastDate(e){this._lastDate=e,this.updateDatabase("dutyLastDate",e)}updateDatabase(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this.id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var T=class{constructor(e,t,s,o,a){this.id=e,this._paid=t,this._price=s,this._status=o,this.referral=a}get paid(){return this._paid}get price(){return this._price}get status(){return this._status}set paid(e){this._paid=e,this.updateField("paidWhenever",e)}set status(e){this._status=e,this.updateField("payment",e)}updateField(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this.id],o=>{o&&console.error(`SQL ERROR: ${o.message}`)})}};var P=class{constructor(e,t,s,o,a,i){this.id=e,this._duty=t,this._lightMode=s,this._replacement=o,this._schedule=a,this._theme=i}get theme(){return this._theme}get schedule(){return this._schedule}get replacement(){return this._replacement}get lightMode(){return this._lightMode}get duty(){return this._duty}updateField(e,t){let s=`UPDATE users SET ${e} = ? WHERE userId = ?`;n.connection.query(s,[t,this.id],o=>{if(o)throw new Error("SQL ERROR in UserSettings")})}set theme(e){let t=/\.(jpeg|jpg|png)$/i.test(e),s=e==="standard"?"standard":t?e:this._theme;this._theme=s,this.updateField("theme",s)}set schedule(e){this._schedule=e,this.updateField("settingsSchedule",e)}set replacement(e){this._replacement=e,this.updateField("settingsReplacement",e)}set lightMode(e){this._lightMode=e,this.updateField("lightMode",e)}set duty(e){this._duty=e,this.updateField("settingsDuty",e)}switchStatus(e){return e==="on"?"off":"on"}switchSchedule(){this._schedule=this.switchStatus(this._schedule),this.updateField("settingsSchedule",this._schedule)}switchReplacement(){this._replacement=this.switchStatus(this._replacement),this.updateField("settingsReplacement",this._replacement)}switchLightMode(){this._lightMode=this._lightMode===0?1:0,this.updateField("lightMode",this._lightMode)}switchDuty(){this._duty=this.switchStatus(this._duty),this.updateField("settingsDuty",this._duty)}};var q=class{constructor(e,t){this._agents=new Map;this.id=e,this._key=t}async load(){try{let[e,t]=await Promise.all([X.agents(this.id),X.user(this.id)]);return e.forEach(s=>this._agents.set(s.userId,s)),this._agentsApprove=await this.calculateApprovedAgents(e),this._user=t,this}catch(e){throw console.error("Error loading UserReferral:",e),e}}get agentsApprove(){return this._agentsApprove}get agents(){return this._agents}get user(){return this._user}get key(){return this._key}insertReferral(e){this._agents.set(e,{agentId:this.id,userId:e,refKey:this._key}),n.connection.query("INSERT INTO referrals (agentId, userId, refKey) VALUES (?, ?, ?)",[this.id,e,this._key],s=>{s&&console.error("SQL ERROR in insertReferral:",s.message)})}async calculateApprovedAgents(e){let t=e.map(async o=>{let a=await new R().load(o.userId);return a.payment.status>1&&a.payment.paid==="true"?1:0});return(await Promise.all(t)).reduce((o,a)=>o+a,0)}},X={agents:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM referrals WHERE agentId = ?",[r],(o,a)=>{if(o)return t(new Error("SQL ERROR in UserReferral - agents: "+o.message));e(a)})}),user:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM referrals WHERE userId = ?",[r],(o,a)=>{if(o)return t(new Error("SQL ERROR in UserReferral - user: "+o.message));e(a[0])})})};var fe=require("telegraf");var J=M(require("dotenv"));J.default.config();var{TOKEN:Y,PASSWORD:Z,SQLHOST:ee,SQLUSER:te,SQLDATABASE:re,SQLPASSWORD:se}=process.env;if(!Y||!Z||!ee||!te||!re||!se)throw new Error("Missing environment variables");var Vt=["<html lang='ru-RUS'><head><meta charset='utf-8'/><title></title><style>","body{","margin: 0;","font-family: Arial, sans-serif;"].join(""),Xt=["-moz-background-size: cover;","-o-background-size: cover;","background-size: cover;","height: fit-content;","width: fit-content;","}","table{","background-color: rgb(0,0,0,0.2);","padding: 10px;","}","td{","background-color: rgba(255,255,255,0.70);","padding: 0 3px;","text-align: center;","height: 25px;","min-width: 50px;","}",".line{","background-color: rgb(0,0,0,0.0);","height: 10px;max-height: 10px","}","</style></head><body><table>"].join(""),Jt="</table></body></html>",ne=new Map().set(-1,"free").set(0,"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D, \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B \u043D\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D").set(1,"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D, \u0444\u0443\u043D\u043A\u0446\u0438\u043E\u043D\u0430\u043B \u0447\u0430\u0441\u0442\u0438\u0447\u043D\u043E \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D").set(2,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 1 \u043C\u0435\u0441\u044F\u0446").set(3,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 2 \u043C\u0435\u0441\u044F\u0446\u0430").set(4,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430").set(5,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 4 \u043C\u0435\u0441\u044F\u0446\u0430").set(6,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 5 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(7,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 6 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(8,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 7 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(9,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 8 \u043C\u0435\u0441\u044F\u0446\u0435\u0432").set(10,"\u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 9 \u043C\u0435\u0441\u044F\u0446\u0435\u0432"),Yt={args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--headless","--no-zygote","--disable-gpu"],headless:!0,ignoreHTTPSErrors:!0},oe={refBonus:(r,e)=>r===1177837026||r===6018898378?40*e:e>10?100:10*e,cost:(r,e,t)=>e-e/100*oe.refBonus(r,t),standard:(r,e)=>[`\u041E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 <b>${Math.round(r)}\u0440</b>`,`\u0412\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u043E\u043F\u043B\u0430\u0442\u0438\u0442\u044C \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u043C\u0435\u0441\u044F\u0446\u0435\u0432(${Math.round(r+e)}\u0440, ${Math.round(r+e*2)}\u0440, ${Math.round(r+e*3)}\u0440, ${Math.round(r+e*4)}\u0440, ${Math.round(r+e*5)}\u0440)`,"\u041F\u0440\u0438 \u043E\u043F\u043B\u0430\u0442\u0435, \u0432 \u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438 \u0443\u043A\u0430\u0437\u044B\u0432\u0430\u0439\u0442\u0435 \u0432\u0430\u0448 id (id \u043C\u043E\u0436\u043D\u043E \u0443\u0437\u043D\u0430\u0442\u044C \u0432\u0432\u0435\u0434\u044F \u043A\u043E\u043C\u0430\u043D\u0434\u0443 /profile)","\u041F\u043E\u0441\u043B\u0435 \u043E\u043F\u043B\u0430\u0442\u044B \u043F\u0440\u043E\u043F\u0438\u0448\u0438\u0442\u0435 /paid \u0434\u043B\u044F \u043E\u043F\u043E\u0432\u0435\u0449\u0435\u043D\u0438\u044F \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438 \u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u0435",'<a href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u0441\u0441\u044B\u043B\u043A\u0430 \u0434\u043B\u044F \u043E\u043F\u043B\u0430\u0442\u044B</a>',"","\u041F\u0440\u0438 \u043E\u043F\u043B\u0430\u0442\u0435 \u0437\u0430 \u0438\u044E\u043D\u044C \u0432\u044B \u043F\u043E\u043B\u0443\u0447\u0430\u0435\u0442\u0435 \u0441\u0442\u0430\u0442\u0443\u0441 \u041E\u043F\u043B\u0430\u0447\u0435\u043D \u043D\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430"].join(`
`),ban:r=>[`\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0437\u0430 \u043D\u0435\u0443\u043F\u043B\u0430\u0442\u0443(\u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443 @a_korop \u0438\u043B\u0438 \u043E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 <b>${Math.round(r*2)}\u0440</b>)`,'\u{1F517}<a href="https://www.tinkoff.ru/rm/korop.aleksandr4/KHtiD43274">\u0441\u0441\u044B\u043B\u043A\u0430 \u0434\u043B\u044F \u043E\u043F\u043B\u0430\u0442\u044B</a>'].join(`
`),changeStatus:r=>`\u0412\u0430\u0448 \u0441\u0442\u0430\u0442\u0443\u0441 \u0438\u0437\u043C\u0435\u043D\u0435\u043D \u043D\u0430 ${ne.get(r)}`},Zt={user:'<b class="profileB">\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start</b>',group:'<b class="profileB">\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443 /setGroup</b>'},er={user:"'\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start'",group:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443 /setgroup"},tr="http://rgkript.ru/raspisanie-zanyatiy/",u={TOKEN:Y,PASSWORD:Z,SQLHOST:ee,SQLUSER:te,SQLDATABASE:re,SQLPASSWORD:se,htmlStart1:Vt,htmlStart2:Xt,htmlEnd:Jt,puppeteer:Yt,payment:ne,paymentMessages:oe,fetchUrl:tr,notfoundMessagesSite:Zt,notfoundMessages:er};var ae=async r=>{if(r.payment.status===1){let e=u.paymentMessages.cost(r.info.id,r.payment.price,r.payment.referral.agentsApprove);await n.telegram.sendMessage(r.info.id,u.paymentMessages.standard(e,r.payment.price),{parse_mode:"HTML"}).catch(console.log)}};var ie=async()=>{let r=["31.01","28.02","31.03","30.04","31.05","30.06","31.07","31.08","30.09","31.10","30.11","31.12"][new Date().getMonth()];n.users.all.filter(e=>e.payment.status===1).forEach(e=>e.sendText(`\u041E\u043F\u043B\u0430\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u0434\u043E ${r}, \u0438\u043D\u0430\u0447\u0435 \u0431\u0443\u0434\u0435\u0442\u0435 \u043E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u044B \u043E\u0442 \u0431\u043E\u0442\u0430`))};var ue=async()=>{let r=n.users.all.sort((t,s)=>t.info.name.localeCompare(s.info.name)),e=[];return r.forEach((t,s)=>{s%5===0&&e.push([]),e[e.length-1].push({text:t.info.name,callback_data:`userPaid${t.info.id}`})}),e};var me=async r=>{if(r.info.id>=0)return!0;let e=await n.telegram.getChatMembersCount(r.info.id),t=r.info.bots,s=n.users.all.map(async o=>{if(o.info.id!==r.info.id&&(o.payment.status===-1||o.payment.status>2)){let a=await n.telegram.getChatMember(r.info.id,o.info.id);["member","creator","administrator"].includes(a.status)&&(t+=1)}});return await Promise.all(s),t===e};var pe=async()=>{for(let r of n.users.all){let e=u.paymentMessages.cost(r.info.id,r.payment.price,r.payment.referral.agentsApprove);if(!(e<=0)){switch(r.payment.status){case 1:r.sendText(u.paymentMessages.ban(r.payment.price));break;case 2:r.sendText(u.paymentMessages.standard(e,r.payment.price));break;default:r.payment.status>2&&r.sendText(u.paymentMessages.changeStatus(r.payment.status-1));break}r.payment.status>0&&r.payment.status--}}};var le=async(r,e)=>{if(!r)return"\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435\u0441\u044C \u0432 \u0431\u043E\u0442\u0435 /start";if(r.payment.paid!=="false"||!r.payment.referral.user)return"\u0412\u044B \u0443\u0436\u0435 \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043B\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447, \u043B\u0438\u0431\u043E \u043E\u043F\u043B\u0430\u0447\u0438\u0432\u0430\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443 \u0440\u0430\u043D\u0435\u0435";let t=n.users.getUserByRefKey(e);return t?r.info.id===t.info.id?"\u0412\u044B \u043D\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0441\u0432\u043E\u0439 \u0436\u0435 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447":(r.payment.status+=1,t.payment.referral.insertReferral(r.info.id),`\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043D \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447!
\u0412\u0430\u0448 \u0441\u0442\u0430\u0442\u0443\u0441 \u0438\u0437\u043C\u0435\u043D\u0435\u043D \u043D\u0430 ${u.payment.get(r.payment.status)}`):`\u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u0430\u0433\u0435\u043D\u0442 \u0434\u043B\u044F \u043A\u043B\u044E\u0447\u0430: ${e}`};var f={alert:ae,preAlert:ie,generateUsersKeyboard:ue,groupIsPaid:me,recount:pe,setReferralKey:le};var R=class{constructor(){}async load(e,t){let s=t?.res?t.res:t?.refKey?await de.refKey(t.refKey):await de.userId(e),{settings:o,info:a,duty:i,payment:m}=await this.loadOptions(s);return this.settings=o,this.info=a,this.duty=i,this.payment=m,this}async loadOptions(e){let t=await new q(e.userId,e.refKey).load();return{duty:new k(e.userId,e.dutyCount,e.dutyDay,e.dutyLastDate),info:new D(e.groupBots,e.groupName,e.userId,e.name,e.userName,e.role),payment:new T(e.userId,e.paidWhenever,e.price,e.payment,t),settings:new P(e.userId,e.settingsDuty,e.lightMode,e.settingsReplacement,e.settingsSchedule,e.theme)}}sendText(e){n.devMode&&this.info.id!==6018898378||(n.telegram.sendMessage(this.info.id,e,{parse_mode:"HTML"}).catch(t=>{console.log(t)}),f.alert(this).catch(t=>{console.log(t)}))}sendAutoDeleteText(e,t){n.telegram.sendMessage(this.info.id,e,{parse_mode:"HTML"}).then(s=>{setTimeout(()=>{n.telegram.deleteMessage(s.chat.id,s.message_id).catch(o=>{console.log(o)})},t)}).catch(s=>{console.log(s)}),f.alert(this).catch(s=>{console.log(s)})}sendPhoto(e,t){n.telegram.sendPhoto(this.info.id,fe.Input.fromBuffer(e,t)).catch(s=>{console.log(s)}),f.alert(this).catch(s=>{console.log(s)})}},de={refKey:async r=>ce("SELECT * FROM users WHERE refKey = ?",[r]),userId:async r=>ce("SELECT * FROM users WHERE userId = ?",[r])};async function ce(r,e){return new Promise((t,s)=>{n.connection.query(r,e,(o,a)=>{if(o)return s(new Error(`SQL ERROR ${o}`));a[0]?t(a[0]):s(new Error("USER not found"))})})}var ge=M(require("node-html-to-image"));var h=class{constructor(e,t){this.gradient=e,this.html=t}async getImage(){let e=`${u.htmlStart1}${this.gradient}${u.htmlStart2}${this.html}${u.htmlEnd}`;return await(0,ge.default)({html:e,puppeteerArgs:u.puppeteer})}};var N=class{constructor(){this.map=new Map;this._all=[]}async load(){let e=await rr.all();return this._all=await Promise.all(e.map(async t=>{let s=await new R().load(t.userId,t);return this.map.set(t.userId,s),s})),this}async createUser(e,t,s,o,a){return new Promise((i,m)=>{n.connection.query("INSERT INTO users (userId, userName, payment, name, refKey) VALUES (?, ?, ?, ?, ?)",[e,t,s,o,a],async(d,p)=>{if(d)return m(new Error("SQL ERROR in Users"));try{let l=await new R().load(e,{res:p[0]});this.map.set(e,l),this._all.push(l),i()}catch(l){m(l)}})})}getUser(e){return this.map.get(e)}getUserByRefKey(e){return this._all.find(t=>t.payment.referral.key===e)}get all(){return this._all}getGroupUsers(e){return this._all.filter(t=>t.info.groupName===e)}async sendPhoto(e,t,s,o,a){await Promise.all(this._all.map(async i=>{let m=i.settings.theme,d=a&&m!=="standard"?await new h(m,a).getImage():e,p=o?await f.groupIsPaid(i):!0;if(i.payment.status!==0&&i.settings[s]==="on"&&p){if(n.devMode&&i.info.id!==6018898378)return;i.sendPhoto(d,t)}}))}sendText(e){for(let t of this._all)if(t.payment.status!==0){if(n.devMode&&t.info.id!==6018898378)return;t.sendText(e)}}},rr={all:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM users",(t,s)=>{if(t)return e(new Error("SQL ERROR in Users"));r(s)})})};var C=class{constructor(){this._light=[];this._dark=[]}get light(){return this.getRandomGradient(this._light)}get dark(){return this.getRandomGradient(this._dark)}getRandomGradient(e){if(e.length===0)return"";let t=Math.floor(Math.random()*e.length);return e[t].css}async load(){return(await sr.gradients()).forEach(t=>{t.type==="light"?this._light.push(t):this._dark.push(t)}),this}},sr={gradients:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM gradients",(t,s)=>{t?e(new Error("SQL ERROR in Gradients")):r(s)})})};var ye=M(require("xlsx"));var L=class{constructor(e,t,s){this.groupName=e,this.html=t,this.link=s}setSchedule(e,t){this.html=e,this.link=t,n.connection.query(`UPDATE groups SET schedule = '${e}' WHERE name = '${this.groupName}'`)}async generateSchedule(e,t){let s=ye.default.read(Buffer.from(await e.clone().arrayBuffer())),o=s.SheetNames,a=s.Sheets[o[1]],i=[];for(let p in a)if(p.startsWith("B")&&a[p].v===this.groupName){let l=Number(p.slice(1))-2,S=l+27;i.push(`<tr><td colspan="7"><b>${a[`B${l}`].v}</b></td></tr>`);for(let w=l+1;w<=S;w++){let c=`<tr>${["A","B","C","D","E","F","G"].map(b=>a[`${b}${w}`]?`<td><b>${a[`${b}${w}`].v}</b></td>`:"<td></td>").join(" ")}</tr>`;i.push((w-l+1)%4===0?`${c}<tr><td colspan="7" class="line"></td></tr>`:c)}break}let d=i.map(p=>p.replace(/ +/g," ")).join("");return this.setSchedule(d,t),d}};var G=class{constructor(e,t,s){this._duties=s,this.groupName=e,this._users=t}getDuty(e,t){return this._duties.filter(s=>s.date>e&&s.date<t)}insertDuty(e,t,s){this._duties.push({group:this.groupName,date:e,user:t,name:s}),n.connection.query(`INSERT INTO duty (\`group\`,\`date\`,\`user\`,\`name\`) values('${this.groupName}','${e}','${t}','${s}')`)}generateHTML(e){let t=this._users,s=Array(6).fill(null).map(()=>[]),o=Array(6).fill(null).map(()=>[]),a=Array(6).fill(null).map(()=>[]),i=[],m=[],d=[];t.forEach(c=>{c.duty.day!==-1&&s[c.duty.day-1].push(c.info.name)}),t.sort((c,b)=>b.duty.count-c.duty.count).forEach(c=>{c.duty.day!==-1&&a[c.duty.day-1].push(`${c.info.name}-${c.duty.count}`)});let p=new Date(Date.now()-6048e5*e),l=new Date(p.setDate(p.getDate()-p.getDay())),S=new Date(l);S.setDate(l.getDate()+6),this.getDuty(l.getTime(),S.getTime()).forEach(c=>{let b=new Date(c.date).getDay();b!==0&&o[b-1].push(c.name)});for(let c=0;c<5;c++){let b=Ot=>`<tr>${Ot.map(At=>`<td><b>${At[c]||""}</b></td>`).join("")}</tr>`;i.push(b(s)),m.push(b(o)),d.push(b(a))}let x=c=>{let b=new Date(l.getTime()+864e5*c);return`${b.getDate()}.${`0${b.getMonth()+1}`.slice(-2)}`};return`
<tr><td colspan="6"><b>\u0414\u0435\u0436\u0443\u0440\u043D\u044B\u0435 \u043F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td></tr>
<tr><td><b>\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A</b></td><td><b>\u0412\u0442\u043E\u0440\u043D\u0438\u043A</b></td><td><b>\u0421\u0440\u0435\u0434\u0430</b></td><td><b>\u0427\u0435\u0442\u0432\u0435\u0440\u0433</b></td><td><b>\u041F\u044F\u0442\u043D\u0438\u0446\u0430</b></td><td><b>\u0421\u0443\u0431\u0431\u043E\u0442\u0430</b></td></tr>
<tr><td colspan="6" class="line"></td></tr>
${i.join("")}
<tr><td colspan="6" class="line"></td></tr>
<tr><td colspan="6"><b>\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438</b></td></tr>
<tr>
${[1,2,3,4,5,6].map(c=>`<td><b>${x(c)}</b></td>`).join("")}
</tr>
<tr><td colspan="6" class="line"></td></tr>
${m.join("")}
<tr><td colspan="6" class="line"></td></tr>
<tr><td colspan="6"><b>\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0435\u0436\u0443\u0440\u0441\u0442\u0432</b></td></tr>
${d.join("")}
`}};var E=class{constructor(){}async load(e,t){let s=t?{name:e,schedule:t}:await he.groups(e);this.name=s.name,this.schedule=new L(this.name,s.schedule,(await new I().load("scheduleLink")).value);let o=await he.duty(e);return this._duty=new G(this.name,this.users,o),this}get users(){return n.users.getGroupUsers(this.name)}get duty(){return this._duty}async sendPhoto(e,t,s,o,a){for(let i of n.users.getGroupUsers(this.name)){let m=i.settings.theme,d=a&&m!=="standard"?await new h(m,a).getImage():e,p=o?await f.groupIsPaid(i):!0;if(i.payment.status!==0&&i.settings[s]==="on"&&p){if(n.devMode&&i.info.id!==6018898378)return;i.sendPhoto(d,t)}}}},he={groups:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM groups WHERE name = ?",[r],(s,o)=>{s?t(new Error("SQL ERROR in Group")):e(o[0])})}),duty:async r=>new Promise((e,t)=>{n.connection.query("SELECT * FROM duty WHERE `group` = ?",[r],(s,o)=>{s?t(new Error("SQL ERROR in Group Duty")):e(o)})})};var O=class{constructor(){this.all=[]}async load(){let e=await nr.replacements();return this.all=e.reverse(),this}insertReplacement(e,t,s){let o={link:e,date:t,html:s};this.all.push(o),n.connection.query("INSERT INTO replacements (link, date, html) VALUES (?, ?, ?)",[e,t,s],i=>{if(i)throw new Error("SQL ERROR in Replacements - insert")})}getReplacement(e){return this.all[e]}},nr={replacements:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM replacements",(s,o)=>{s?e(new Error("SQL ERROR in Replacements - select")):r(o)})})};var we=require("telegraf");var Se=require("mysql");var be=M(require("xlsx")),A=class{constructor(){this.all=[];this.map=new Map}async load(){let e=await or.all();return this.all=await Promise.all(e.map(async t=>{let s=await new E().load(t.name,t.schedule.html);return this.map.set(t.name,s),s})),this}isGroupInText(e){return e=e.replace(" ","-").toLowerCase(),this.all.find(t=>e.includes(t.name.toLowerCase()))}getGroup(e){return this.map.get(e)}async parseGroups(e){let t=await fetch(e),s=be.default.read(Buffer.from(await t.clone().arrayBuffer())),o=s.SheetNames,a=s.Sheets[o[1]],i=[];for(let m in a)m.startsWith("B")&&a[m].v.trim().match(/^[А-Я]+-[0-9][0-9]$|^[А-Я]+-[0-9][0-9][а-я]$/ig)&&(this.getGroup(a[m].v.trim())||(await this.setGroup(a[m].v.trim()),i.push(a[m].v.trim())));return`\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u044B \u0433\u0440\u0443\u043F\u043F\u044B: ${i.join(", ")}`}setGroup(e){return new Promise((t,s)=>{n.connection.query("INSERT INTO groups (name) VALUES (?)",[e],async o=>{if(o)return s(new Error("SQL ERROR in setGroup"));try{let a=await new E().load(e,"null");this.map.set(e,a),this.all.push(a),t()}catch(a){s(a)}})})}},or={all:async()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM groups",(t,s)=>{t?e(new Error("SQL ERROR in Groups")):r(s)})})};var ar={host:u.SQLHOST,user:u.SQLUSER,database:u.SQLDATABASE,password:u.SQLPASSWORD},Q=class extends we.Telegraf{constructor(){super(u.TOKEN);this.devMode=!1;this.connection=(0,Se.createPool)(ar)}launchBot(){this.launch(),this.sendTemporaryMessage(6018898378,"\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D!"),console.log("\u0411\u043E\u0442 \u0437\u0430\u043F\u0443\u0449\u0435\u043D")}async loadData(t,s){let o=await t();return await this.sendTemporaryMessage(6018898378,s),console.log(s),o}async addGradients(){this.gradients=await this.loadData(()=>new C().load(),"\u0413\u0440\u0430\u0434\u0438\u0435\u043D\u0442\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addGroups(){this.groups=await this.loadData(()=>new A().load(),"\u0413\u0440\u0443\u043F\u043F\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addUsers(){this.users=await this.loadData(()=>new N().load(),"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async addReplacements(){this.replacements=await this.loadData(()=>new O().load(),"\u0417\u0430\u043C\u0435\u043D\u044B \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u044B")}async sendTemporaryMessage(t,s){try{let o=await this.telegram.sendMessage(t,s);setTimeout(()=>{this.telegram.deleteMessage(o.chat.id,o.message_id).catch(console.error)},30*1e3)}catch(o){console.error(o)}}};var H=class{constructor(){this.all=new Map}async load(){let e=await ir.all();return await Promise.all(e.map(async t=>{let s=new I;await s.load(t.type,t),this.all.set(t.type,s)})),this}getSettings(e){return this.all.get(e)}},ir={all:()=>new Promise((r,e)=>{n.connection.query("SELECT * FROM settings",(s,o)=>{s?e(new Error("SQL ERROR in Settings")):r(o)})})};var _e=M(require("pdf-parse")),xe=M(require("word-extractor")),ur=new xe.default,B=class{constructor(e,t){this.replIgnore=["\u0413\u0440\u0443\u043F\u043F\u0430","\u041F\u0410\u0420\u0410","\u041F\u0420\u0415\u041F\u041E\u0414\u0410\u0412\u0410\u0422\u0415\u041B\u042C","\u0417\u0410\u041C\u0415\u041D\u0410","\u0420\u0410\u0421\u041F\u0418\u0421\u0410\u041D\u0418\u042E"];this.buffer=e,this.fileType=t}async getData(){switch(this.fileType){case"doc":return(await ur.extract(this.buffer)).getBody();case"pdf":return(await(0,_e.default)(this.buffer)).text}}async getReplacementData(){return this.data=await this.getData(),this.data.replace(/\t/g," ").split(`
`).filter(e=>!this.replIgnore.some(t=>e.startsWith(t))&&e.trim()!==""&&e.replace(/\s/g,"")!=="\u041F\u041E")}};var W=class{constructor(e){this._date=e.date,this.text=e.text,this._link=e.link}get date(){return this._date}get link(){return this._link}async getHtml(){return this._html=await this.generateHTML(),this._html}async parseText(){let e=[],t=0;for(;t<this.text.length;){let s=this.text[t];if(s?.match(/ЗАМЕНЫ/g))e.push({text:`${s} ${this.text[t+1]}`,group:null,pair:"null",auditorium:"null"}),t+=2;else{let o=n.groups.isGroupInText(s);if(o){let a=[s],i=1;for(;this.text[t+i]&&!n.groups.isGroupInText(String(this.text[t+i]))&&!this.text[t+i].match(/ЗАМЕНЫ/g);)a.push(this.text[t+i]),i++;let m=a.join(" ").slice(o.name.length+1).replace(/ +/g," "),[d]=m.split(/\. (?=[А-Яа-я0-9(])|\) (?=[А-Яа-я0-9(])/g).reverse(),p=m.match(/[0-9]п([,\-])[0-9]п|[0-9]([,\-])[0-9]п|[0-9]п|[0-9]/),l=p?p[0]:void 0,S=l?m.replace(l,"").replace(d,"").trim():m.trim();e.push({text:S,group:o,pair:l,auditorium:d}),t+=a.length}}}return e}async generateHTML(){let e=await this.parseText(),t=[],s=(i,m)=>!!(i[m+1]&&i[m+1].startsWith("(")),o=(i,m)=>`<tr><td><b>${i.group?.name||""}</b></td><td><b>${i.pair||""}</b></td>${m}<td><b>${i.auditorium||""}</b></td></tr>`,a=i=>{switch(i.length){case 1:return`<td colspan="2"><b>${i[0]}</b></td><td><b></b></td><td colspan="2"><b></b></td>`;case 2:return`<td colspan="2"><b>${i[0]}</b></td><td><b></b></td><td colspan="2"><b>${i[1]}</b></td>`;case 3:return`<td colspan="2"><b>${i[0]}</b></td><td><b>${i[1]}</b></td><td colspan="2"><b>${i[2]}</b></td>`;case 4:return`<td><b>${i[0]}</b></td><td><b>${i[1]}</b></td><td></td><td><b>${i[2]}</b></td><td><b>${i[3]}</b></td>`;default:return`<td colspan="5"><b>${i.join(" ")}</b></td>`}};for(let i of e)if(!i.group)t.push(`<tr><td colspan="8"><b>${i.text}</b></td></tr>`,'<tr><td><b>\u0413\u0440\u0443\u043F\u043F\u0430</b></td><td><b>\u041F\u0430\u0440\u0430</b></td><td colspan="2"><b>\u041F\u043E \u0440\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u044E</b></td><td><b><===></b></td><td colspan="2"><b>\u0417\u0430\u043C\u0435\u043D\u0430</b></td><td><b>\u0410\u0443\u0434\u0438\u0442\u043E\u0440\u0438\u044F</b></td></tr>','<tr><td colspan="8" class="line"></td></tr>');else{let m=i.text.replace(/ +/g," ").match(/[А-Я][а-я]+ [А-Я].[А-Я].|\([а-я]+\)|\([А-Яа-я0-9 .]+ +[А-Яа-я0-9 .]+\)|[А-Яа-я0-9]+/g)||[],d=[],p=0;for(;p<m.length;)if(s(m,p)){let x=[m[p],`
${m[p+1]}`],c=2;for(;s(m,p+c);)x.push(`
${m[p+c]}`),c++;p+=c,d.push(x.join(" "))}else d.push(m[p]),p++;let l=a(d),w=e[e.indexOf(i)+1]?.group===null;t.push(o(i,l)),w&&t.push('<tr><td colspan="8" class="line"></td></tr>')}return t.join("")}};var F=require("telegraf"),K=async r=>[[F.Markup.button.callback(`\u0414\u0435\u0436\u0443\u0440\u0441\u0442\u0432\u0430: ${r.settings.duty}`,`settingsDuty${r.info.id}`),F.Markup.button.callback(`\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${r.settings.schedule}`,`settingsSchedule${r.info.id}`),F.Markup.button.callback(`\u0417\u0430\u043C\u0435\u043D\u044B: ${r.settings.replacement}`,`settingsReplacement${r.info.id}`)]];var Me=async(r,e,t)=>{let s=Number(e.replace(/^\D+/g,"")),o=n.users.getUser(s);if(!o){await r.reply(u.notfoundMessages.user);return}switch(t){case"duty":o.settings.switchDuty();break;case"schedule":o.settings.switchSchedule();break;case"replacement":o.settings.switchReplacement();break}await r.editMessageText("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438:",{reply_markup:{inline_keyboard:await K(o)}})};var Re=async(r,e)=>{let t=parseInt(e.slice(10),10),s=n.users.getUser(t);if(!s){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}s.sendText("\u041E\u0448\u0438\u0431\u043A\u0430. \u0412\u044B \u043D\u0435 \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443!");let o=r.callbackQuery?.message?.message_id,a=r.callbackQuery?.from.id;o&&a&&await n.telegram.deleteMessage(a,o)};var Ie=async(r,e)=>{let t=r.from?.id,s=parseInt(e.slice(10),10),o=new Map([[1,"\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A"],[2,"\u0412\u0442\u043E\u0440\u043D\u0438\u043A"],[3,"\u0421\u0440\u0435\u0434\u0430"],[4,"\u0427\u0435\u0442\u0432\u0435\u0440\u0433"],[5,"\u041F\u044F\u0442\u043D\u0438\u0446\u0430"],[6,"\u0421\u0443\u0431\u0431\u043E\u0442\u0430"]]);if(!t)return;let a=n.users.getUser(t);if(!a){await r.reply(u.notfoundMessages.user);return}a.duty.day=s,await r.editMessageText(`\u0423\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D \u0434\u0435\u043D\u044C: ${o.get(s)}`)};var Ue=async(r,e)=>{let t=r.from?.id,s=e.slice(8);if(!t)return;let o=n.users.getUser(t);if(!o){await r.reply(u.notfoundMessages.user);return}o.info.groupName=s,await r.editMessageText(`\u0423\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0433\u0440\u0443\u043F\u043F\u0430: ${s}`)};var ve=require("telegraf");var U=async(r,e)=>{let s=[{label:"true",value:`userStatus_2___${e.info.id}`},{label:"false",value:`userStatus_1___${e.info.id}`},{label:"free",value:`userStatus_f___${e.info.id}`},{label:"vip",value:`userStatus_vip_${e.info.id}`},{label:"ban",value:`userStatus_0___${e.info.id}`},{label:"\u21A9\uFE0F",value:"userStatus_undo"}].map(o=>ve.Markup.button.callback(o.label,o.value));await r.editMessageText(`\u0422\u0435\u043A\u0443\u0449\u0438\u0439 \u0441\u0442\u0430\u0442\u0443\u0441: ${u.payment.get(e.payment.status)}
\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u043D\u0430:`,{reply_markup:{inline_keyboard:[s]}})};var Ee=require("telegraf");var $e=async(r,e)=>{let t=Number(e.split("_").pop()),s=n.users.getUser(t),o=[{label:"2\u043C\u0435\u0441",value:`vipStatus_3_${t}`},{label:"3\u043C\u0435\u0441",value:`vipStatus_4_${t}`},{label:"4\u043C\u0435\u0441",value:`vipStatus_5_${t}`},{label:"5\u043C\u0435\u0441",value:`vipStatus_6_${t}`},{label:"6\u043C\u0435\u0441",value:`vipStatus_7_${t}`},{label:"\u21A9\uFE0F",value:"userStatus_undo"}];if(e.includes("vip")){let a=o.map(i=>Ee.Markup.button.callback(i.label,i.value));await r.editMessageText("\u0423\u0440\u043E\u0432\u0435\u043D\u044C VIP:",{reply_markup:{inline_keyboard:[a]}})}else if(e.includes("undo")){let a=await f.generateUsersKeyboard();await r.editMessageText("\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u043B\u044F:",{reply_markup:{inline_keyboard:a}})}else if(s){let a=e.slice(11).startsWith("f")?-1:Number(e.charAt(11));s.payment.status=a,s.payment.paid="true",await U(r,s);let i=a===0?"\u0412\u044B \u0431\u044B\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C":u.paymentMessages.changeStatus(a);s.sendText(i)}else await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D")};var De=async(r,e)=>{let t=e.split("_"),s=parseInt(t[1],10),o=parseInt(t[2],10),a=n.users.getUser(o);if(!a){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}a.payment.status=s,a.payment.paid="true",await U(r,a);let i=u.paymentMessages.changeStatus(s);a.sendText(i)};var _={paidStatus:Re,setDutyDay:Ie,setGroup:Ue,userPaid:U,userStatus:$e,vipStatus:De,settings:{keyboard:K,updateSettings:Me}};var ke=()=>{n.on("callback_query",async r=>{let e=r.callbackQuery?.data;if(e)if(e.startsWith("userPaid")){let t=Number(e.slice(8)),s=n.users.getUser(t);if(!s){await r.reply("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}await _.userPaid(r,s)}else e.startsWith("paidStatus")?await _.paidStatus(r,e):e.startsWith("userStatus")?await _.userStatus(r,e):e.startsWith("vipStatus")?await _.vipStatus(r,e):e.startsWith("settings")?await _.settings.updateSettings(r,e,e.slice(8).toLowerCase().replace(/[0-9]+/g,"")):e.startsWith("setGroup")?await _.setGroup(r,e):e.startsWith("setDutyDay")&&await _.setDutyDay(r,e)})};async function Te(r){if(!r.chat?.id||!r.from?.username)return;let e=r.chat.id,t=r.from.username;n.users.getUser(e)||(await n.users.createUser(e,t,2,t,await mr(e)),await n.telegram.sendMessage(6018898378,`${e} ${t}, \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0438\u043B\u0441\u044F \u043A \u0431\u043E\u0442\u0443`)),await r.reply(`\u0412\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0430\u043A\u0442\u0438\u0432\u0438\u0440\u043E\u0432\u0430\u043B\u0438 \u0431\u043E\u0442\u0430!
\u0414\u043B\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E\u0439 \u0440\u0430\u0431\u043E\u0442\u044B \u043F\u0440\u043E\u043F\u0438\u0448\u0438\u0442\u0435 (/setname \u0432\u0430\u0448\u0430 \u0444\u0430\u043C\u0438\u043B\u0438\u044F) \u0438 (/setgroup).
\u0412\u044B \u0442\u0430\u043A\u0436\u0435 \u043C\u043E\u0436\u0435\u0442\u0435 \u0432\u0432\u0435\u0441\u0442\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447 \u043A\u043E\u043C\u0430\u043D\u0434\u043E\u0439 (/referral \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447), \u0432\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u0435 \u0434\u043E\u0441\u0442\u0443\u043F \u043A\u043E \u0432\u0441\u0435\u043C \u0444\u0443\u043D\u043A\u0446\u0438\u044F\u043C \u043D\u0430 \u043C\u0435\u0441\u044F\u0446 \u0431\u0435\u0441\u043F\u043B\u0430\u0442\u043D\u043E (\u0434\u043E 1-\u0433\u043E \u0447\u0438\u0441\u043B\u0430 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u0433\u043E \u043C\u0435\u0441\u044F\u0446\u0430)`)}async function mr(r){return r<0?"null":r.toString().split("").map(Number).map(e=>(e||10)+64).map(e=>String.fromCharCode(e)).join("")}async function Pe(r){let e=r.chat?.id,t=r.text?.slice(6).trim();if(e!==6018898378||!t||t.startsWith("monica_schedule_bot")){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}n.users.sendText(t)}async function qe(r){await r.reply("\u041D\u0435 \u0443\u0434\u0430\u043B\u044F\u0439\u0442\u0435 \u044D\u0442\u043E \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435!",{reply_markup:{resize_keyboard:!0,keyboard:[["\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B"]]}})}var Ne=async()=>{let r=n.gradients.light;for(let e of n.groups.all){let t=e.duty.generateHTML(0),s=await new h(r,t).getImage();await e.sendPhoto(s,"duty.png","duty",!0,t)}};var Ce=async(r,e)=>{try{let t=await fetch(r);if(!t.ok){console.log(`Failed to fetch: ${t.statusText}`),await n.telegram.sendMessage(6018898378,"\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B");return}let s=Buffer.from(await t.arrayBuffer()),o=r.slice(-3),a=new Date(`${e.slice(-4)}-${e.slice(3,5)}-${e.slice(0,2)}`).getTime(),i=new W({date:a,text:await new B(s,o).getReplacementData(),link:r}),m=n.replacements.getReplacement(0),d=await i.getHtml();if(d!==m?.html){n.replacements.insertReplacement(i.link,i.date,d);let p=n.gradients.dark,l=await new h(p,d).getImage();await n.users.sendPhoto(l,"replacement.png","replacement",!0,d)}}catch(t){console.log(`Error during processing: ${t}`),await n.telegram.sendMessage(6018898378,"\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B")}};var Le=async r=>{try{let e=await fetch(r);if(!e.ok){await n.telegram.sendMessage(6018898378,"\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E");return}let t=n.groups.all;for(let s of t)if(s.users.length>0){await s.schedule.generateSchedule(e,r);let{html:o}=s.schedule;if(o&&o!=="null")try{let a=n.gradients.light,i=await new h(a,o).getImage();await s.sendPhoto(i,"schedule.png","schedule",!0,o)}catch(a){console.log(`Error while sending photo for group ${s.name}: ${a}`)}}}catch(e){console.log(`Error during processing: ${e}`),await n.telegram.sendMessage(6018898378,"\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E")}};var j={duty:Ne,replacement:Ce,schedule:Le};async function Ge(r,e){if(r!==6018898378){e&&await e.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let t=n.users.getUser(r);if(!t)return;let s=await new H().load(),o=s.getSettings("scheduleLink"),a=s.getSettings("replacementLink"),i=await(await fetch(u.fetchUrl)).text(),m=new Date().getFullYear(),d=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+m+'[0-9/.\\-A-Za-z_]+"',"g"),p=/<strong>[А-Яа-я0-9. ]+/g,l=Array.from(new Set(i.match(d))).map(x=>x.slice(9,-1)),S=i.match(p);if(!S){t.sendText("DateArr not found");return}let w=S.map(x=>x.match(/[0-9]+.[0-9]+.[0-9]+/g)?.[0]).filter(Boolean);o&&l[0]!==o.value?(o.value=l[0],t.sendAutoDeleteText(`\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${w[0]} ${l[0].slice(36)}`,1e3*30),await j.schedule(l[0])):t.sendAutoDeleteText("\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E",1e3*30),a&&l[1]!==a.value?(a.value=l[1],t.sendAutoDeleteText(`\u0417\u0430\u043C\u0435\u043D\u044B: ${w[1]} ${l[1].slice(36)}`,1e3*30),await j.replacement(l[1],w[1])):t.sendAutoDeleteText("\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B",1e3*30)}async function Oe(r){let e=r.chat?.id;if(!e){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430: \u0447\u0430\u0442 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D");return}let t=n.users.getUser(e);if(!t){await r.reply(u.notfoundMessages.user);return}if(t.info.id<=0){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430. \u041A\u043E\u043C\u0430\u043D\u0434\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0438\u0437 \u0433\u0440\u0443\u043F\u043F\u044B");return}let s=`${t.info.name}(${t.info.id}) \u043E\u043F\u043E\u0432\u0435\u0441\u0442\u0438\u043B \u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u0435, \u0441\u0442\u0430\u0442\u0443\u0441: ${u.payment.get(t.payment.status)}`,o={inline_keyboard:[[{text:"\u041D\u0435 \u043E\u043F\u043B\u0430\u0447\u0435\u043D\u043E",callback_data:`paidStatus${t.info.id}`},{text:"\u041E\u043F\u043B\u0430\u0447\u0435\u043D\u043E",callback_data:`userPaid${t.info.id}`}]]};await n.telegram.sendMessage(6018898378,s,{reply_markup:o}),await r.reply("\u0417\u0430\u043F\u0440\u043E\u0441 \u043D\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0443 \u043E\u043F\u043B\u0430\u0442\u044B \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D, \u043E\u0436\u0438\u0434\u0430\u0439\u0442\u0435")}async function Ae(r){let e=r.chat?.id;if(!e)return;let t=n.users.getUser(e);if(!t){await r.reply(u.notfoundMessages.user);return}let{groupName:s,id:o,name:a}=t.info,i=t.payment.referral.key,m=u.paymentMessages.refBonus(t.info.id,t.payment.referral.agentsApprove),d=u.payment.get(t.payment.status),p=Math.floor(t.payment.price-t.payment.price*(m/100)),l=`
        \u0413\u0440\u0443\u043F\u043F\u0430: <b>${s}</b>
        Id: \u{1F517}<code>${o}</code>
        \u0424\u0430\u043C\u0438\u043B\u0438\u044F: <b>${a}</b>
        \u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u043F\u043B\u0430\u0442\u044B: <b>${d}</b>
        \u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u0441 \u0443\u0447\u0435\u0442\u043E\u043C \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043A\u0438: <b>${p}</b>
        \u0420\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447: \u{1F517}<code>${i}</code>
        \u0411\u043E\u043D\u0443\u0441 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u043E\u0432: <b>${m}%</b>
        \u0421\u0432\u044F\u0437\u044C \u0441 \u0430\u0434\u043C\u0438\u043D\u043E\u043C: @a_korop
    `.replace(/\n +/g,`
`);await r.reply(l,{parse_mode:"HTML"})}async function Qe(r){let e=r.chat?.id,t=r.text?.slice(10).trim();if(!e)return;let s=n.users.getUser(e);if(!s){await r.reply(u.notfoundMessages.user);return}if(!t){await r.reply("\u0412\u044B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043B\u0438 \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447(/referral \u0440\u0435\u0444\u0435\u0440\u0430\u043B\u044C\u043D\u044B\u0439 \u043A\u043B\u044E\u0447)");return}let o=await f.setReferralKey(s,t);await r.reply(o)}async function He(r){let e=r.chat?.id;if(!e)return;let t=n.users.getUser(e);if(!t){await r.reply(u.notfoundMessages.user);return}if(t.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B");return}if(!await f.groupIsPaid(t)){await r.reply("\u041D\u0435 \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u0433\u0440\u0443\u043F\u043F\u044B \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443");return}let o=n.replacements.getReplacement(0);if(!o){await r.reply("\u0417\u0430\u043C\u0435\u043D\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B");return}let a=t.settings.theme==="standard"?n.gradients.dark:`background-image: url(${t.settings.theme});`,i=await new h(a,o.html).getImage();t.sendPhoto(i,"schedule.png")}async function Be(r){r.chat?.id===6018898378?(await r.reply("\u0411\u043E\u0442 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D!"),setTimeout(()=>{process.exit(0)},1e3*30)):await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412")}async function We(r){let e=r.chat?.id;if(!e)return;let t=n.users.getUser(e);if(!t){await r.reply(u.notfoundMessages.user);return}if(t.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B");return}let s=n.groups.getGroup(t.info.groupName);if(t.info.groupName==="null"||!s){await r.reply(u.notfoundMessages.group);return}let o=s.schedule.html;if(o==="null"){await r.reply("\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E");return}if(!await f.groupIsPaid(t)){await r.reply("\u041D\u0435 \u0432\u0441\u0435 \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u0438 \u0433\u0440\u0443\u043F\u043F\u044B \u043E\u043F\u043B\u0430\u0442\u0438\u043B\u0438 \u043F\u043E\u0434\u043F\u0438\u0441\u043A\u0443");return}let i=t.settings.theme==="standard"?n.gradients.light:`background-image: url(${t.settings.theme});`,m=await new h(i,o).getImage();t.sendPhoto(m,"schedule.png")}async function Fe(r){let e=r.chat?.id;if(!e)return;if(n.users.getUser(e)){n.groups.all.sort((o,a)=>o.name.localeCompare(a.name));let s=[];n.groups.all.forEach((o,a)=>{let i=Math.floor(a/5);s[i]||(s[i]=[]),s[i].push({text:o.name,callback_data:`setGroup${o.name}`})}),await r.reply("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0433\u0440\u0443\u043F\u043F\u0443:",{reply_markup:{inline_keyboard:s}})}else await r.reply(u.notfoundMessages.user)}async function Ke(r){if(!r.chat?.id)return;let e=n.users.getUser(r.chat.id);if(!e){await r.reply(u.notfoundMessages.user);return}let t=r.text?.slice(9);t?(e.info.name=t,await r.reply(`\u0412\u0430\u0448\u0435 \u0438\u043C\u044F - ${t}`)):await r.reply("\u0412\u044B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043B\u0438 \u0438\u043C\u044F (/setname \u0432\u0430\u0448\u0435 \u0438\u043C\u044F)")}async function je(r){if(!r.chat?.id)return;let e=n.users.getUser(r.chat.id);if(!e){await r.reply(u.notfoundMessages.user);return}let t=await _.settings.keyboard(e);await r.reply("\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438:",{reply_markup:{inline_keyboard:t}})}async function ze(r){if(r.chat?.id!==6018898378){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let e=await f.generateUsersKeyboard();await r.reply("\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u0434\u043B\u044F:",{reply_markup:{inline_keyboard:e}})}async function Ve(r){if(!r.chat?.id)return;let e=n.users.getUser(r.chat.id);if(!e){await r.reply(u.notfoundMessages.user);return}if(e.payment.status===0){await r.reply("\u0412\u044B \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u043E\u043C");return}let t=r.text?.slice(7);if(!t||t.startsWith("monica_schedule_bot")){await r.reply("\u041E\u0448\u0438\u0431\u043A\u0430,\u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443, \u043A\u043E\u043C\u0430\u043D\u0434\u0430 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0430 \u0438\u0437 \u0433\u0440\u0443\u043F\u043F\u044B \u0438\u043B\u0438 \u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0435 \u0432\u0435\u0434\u0435\u0442 \u043D\u0430 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443");return}e.settings.theme=t,await r.reply(`\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0442\u0435\u043C\u0430: ${e.settings.theme}`)}async function Xe(r){let e=r.chat?.id;if(!e)return;if(!n.users.getUser(e)){await r.reply(u.notfoundMessages.user);return}let o=[{name:"\u041F\u043D\u0434",value:1},{name:"\u0412\u0442\u0440",value:2},{name:"\u0421\u0440\u0434",value:3},{name:"\u0427\u0442\u0432",value:4},{name:"\u041F\u0442\u043D",value:5},{name:"\u0421\u0431\u0442",value:6}].map(a=>({text:a.name,callback_data:`setDutyDay${a.value}`}));await r.reply("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0434\u0435\u043D\u044C:",{reply_markup:{inline_keyboard:[o]}})}async function Je(r){if(r.from?.id!==6018898378){await r.reply("\u041D\u0430\u043F\u0438\u0441\u0430\u043D\u043E \u0436\u0435 \u0414\u041B\u042F \u0410\u0414\u041C\u0418\u041D\u041E\u0412");return}let e=await(await fetch(u.fetchUrl)).text(),t=new Date().getFullYear(),s=new RegExp('<a href="http:\\/\\/rgkript.ru\\/wp-content\\/uploads\\/\\/'+t+'[0-9/.\\-A-Za-z_]+"',"g"),o=Array.from(new Set(e.match(s))).map(i=>i.slice(9,-1)),a=await n.groups.parseGroups(o[0]);await r.reply(a)}var y={start:Te,send:Pe,duty:qe,fetch:Ge,paid:Oe,profile:Ae,referral:Qe,replacement:He,restart:Be,schedule:We,setGroup:Fe,setName:Ke,settings:je,status:ze,theme:Ve,setDutyDay:Xe,parseGroups:Je};var pr={start:y.start,fetch:r=>y.fetch(r.chat.id,r),send:y.send,schedule:y.schedule,theme:y.theme,status:y.status,settings:y.settings,profile:y.profile,setname:y.setName,setgroup:y.setGroup,referral:y.referral,paid:y.paid,replacement:y.replacement,restart:y.restart,duty:y.duty,setdutydate:y.setDutyDay,parsegroups:y.parseGroups},Ye=()=>{Object.entries(pr).forEach(([r,e])=>{n.command(r,async t=>{await e(t)})})};var Ze=require("cron");var z=(r,e)=>{new Ze.CronJob(r,async()=>{try{await e()}catch(t){console.error(t)}},null,!0)},et=()=>{z("0 10 14 * * 1-5,7",()=>y.fetch(6018898378)),z("0 0 13 1 * *",f.recount),z("0 35 7 25-31 * *",f.preAlert)};var Tt=M(require("express")),Pt=M(require("cors")),qt=M(require("http"));var tt=async r=>({table:n.replacements.getReplacement(r)?.html??"null"});var rt={table:tt};var st=r=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};let t=n.groups.getGroup(e.info.groupName);return t?{table:t.schedule.html!=="null"?t.schedule.html:"<tr><td><b>\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E!</b></td></tr>"}:{table:u.notfoundMessagesSite.group}};var nt=r=>{let e=n.groups.getGroup(r);return e?{table:e.schedule.html!=="null"?e.schedule.html:"<tr><td><b>\u0420\u0430\u0441\u043F\u0438\u0441\u0430\u043D\u0438\u0435 \u0435\u0449\u0435 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u0433\u0435\u043D\u0435\u0440\u0438\u0440\u043E\u0432\u0430\u043D\u043E!</b></td></tr>"}:{table:u.notfoundMessagesSite.group}};var ot=r=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};let t=[],s=[];for(let o of n.groups.all.values())o.name===e.info.groupName?t.push(`<option selected value='${o.name}'>${o.name}</option>`):o.schedule.html==="null"?s.push(`<option disabled value='${o.name}'>${o.name}</option>`):t.push(`<option value='${o.name}'>${o.name}</option>`);return{table:t.concat(s).join("")}};var at={table:st,update:nt,select:ot};var it={replacement:rt,schedule:at};var ut=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};let s=n.groups.getGroup(t.info.groupName);return s?{table:s.duty.generateHTML(e)}:{table:u.notfoundMessagesSite.group}};var mt=r=>{let e=n.users.getUser(r);if(!e)return{alert:u.notfoundMessagesSite.user};let t=n.groups.getGroup(e.info.groupName);if(!t)return{alert:u.notfoundMessagesSite.group};let s=Date.now(),o=new Date().getDay();if(o!==0&&e.payment.status!==0&&e.duty.lastDate+432e5<=s){t.duty.insertDuty(s,e.info.id,e.info.name),e.duty.count+=1,e.duty.lastDate=s;let a=t.users.filter(i=>(i.info.role==="admin"||i.duty.day===o)&&i.info.groupName===e.info.groupName);for(let i of a)n.devMode&&i.info.id!==6018898378||i.sendText(`${e.info.name} \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B, \u0435\u0441\u043B\u0438 \u043D\u0435\u0442 \u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443`);return{alert:"\u0423\u0441\u043F\u0435\u0448\u043D\u043E!"}}else return{alert:"\u0421\u0435\u0433\u043E\u0434\u043D\u044F \u0432\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435, \u0432\u044B \u0443\u0436\u0435 \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438 \u0438\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B"}};var pt={table:ut,checkin:mt};var lt=(r,e)=>{let t=n.users.getUser(r);if(!t)return u.notfoundMessagesSite.user;let s=Math.floor(u.paymentMessages.cost(t.info.id,t.payment.price,t.payment.referral.agentsApprove)+(e-1)*t.payment.price);return`\u0421\u0443\u043C\u043C\u0430 \u043E\u043F\u043B\u0430\u0442\u044B \u043D\u0430 ${e} \u043C\u0435\u0441\u044F\u0446\u0435\u0432: ${s}`};var dt=async(r,e)=>{let t=n.users.getUser(r);return t?f.setReferralKey(t,e):u.notfoundMessagesSite.user};var ct=r=>{let e=n.users.getUser(r);if(!e)return;let t=u.paymentMessages.refBonus(e.info.id,e.payment.referral.agentsApprove),s=new Map([[1,"\u041F\u043E\u043D\u0435\u0434\u0435\u043B\u044C\u043D\u0438\u043A"],[2,"\u0412\u0442\u043E\u0440\u043D\u0438\u043A"],[3,"\u0421\u0440\u0435\u0434\u0430"],[4,"\u0427\u0435\u0442\u0432\u0435\u0440\u0433"],[5,"\u041F\u044F\u0442\u043D\u0438\u0446\u0430"],[6,"\u0421\u0443\u0431\u0431\u043E\u0442\u0430"],[-1,"\u041D\u0435 \u0437\u0430\u0434\u0430\u043D\u043E"]]),o=Array.from(n.groups.all.values()).map(m=>`<option value='${m.name}' ${m.name===e.info.groupName?"selected":""}>${m.name}</option>`).join(""),a=Array.from(s.entries()).map(([m,d])=>`<option value='${m}' ${m===e.duty.day?"selected":""}>${d}</option>`).join(""),i=Math.floor(e.payment.price-e.payment.price*(t/100));return{name:e.info.name,groupName:e.info.groupName,duty:s.get(e.duty.day),payment:u.payment.get(e.payment.status),refKey:e.payment.referral.key,refBonus:String(t),paymentAmount:String(i),groupOptions:o,dutyDayOptions:a}};var ft={monthPay:lt,refKey:dt,table:ct};var gt={};var yt=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};t.duty.day=e};var ht=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};t.info.groupName=e};var bt=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};t.info.name=e};var wt={dutyDay:yt,group:ht,name:bt};var St={info:ft,referrals:gt,settings:wt};var _t=r=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.settings.switchDuty()};var xt=r=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.settings.switchReplacement()};var Mt=r=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.settings.switchSchedule()};var Rt=r=>{let e=n.users.getUser(r);if(e)return{duty:e.settings.duty,schedule:e.settings.schedule,replacement:e.settings.replacement}};var It={duty:_t,replacement:xt,schedule:Mt,table:Rt};var Ut=(r,e)=>{let t=n.users.getUser(r);if(!t)return{table:u.notfoundMessagesSite.user};t.settings.theme=e};var vt=r=>{let e=n.users.getUser(r);if(!e)return{table:u.notfoundMessagesSite.user};e.settings.switchLightMode()};var Et=r=>{let e=n.users.getUser(r);if(e)return{lightMode:e.settings.lightMode}};var $t={background:Ut,lightMode:vt,table:Et};var Dt={notifications:It,theme:$t};var kt=r=>{let e=n.users.getUser(r);if(!e)return{gradient:n.gradients.light.slice(11,-1)};let{theme:t,lightMode:s}=e.settings,o=s===0?n.gradients.light:n.gradients.dark;return{gradient:t==="standard"?o.slice(11,-1):`url(${t})`}};var g={home:it,duty:pt,profile:St,settings:Dt,gradient:kt};var Nt=()=>{let r=(0,Tt.default)();r.use((0,Pt.default)()),r.get("/home/schedule/table",async(t,s)=>{s.send(g.home.schedule.table(Number(t.query.user)))}),r.get("/home/schedule/select",async(t,s)=>{s.send(g.home.schedule.select(Number(t.query.user)))}),r.get("/home/schedule/update",async(t,s)=>{s.send(g.home.schedule.update(String(t.query.group)))}),r.get("/home/replacement/table",async(t,s)=>{s.send(await g.home.replacement.table(Number(t.query.page)))}),r.get("/duty/table",async(t,s)=>{s.send(g.duty.table(Number(t.query.user),Number(t.query.page)))}),r.get("/duty/checkin",async(t,s)=>{s.send(g.duty.checkin(Number(t.query.user)))}),r.get("/profile/info/table",async(t,s)=>{s.send(g.profile.info.table(Number(t.query.user)))}),r.get("/profile/settings/group",async(t,s)=>{g.profile.settings.group(Number(t.query.user),String(t.query.group)),s.send()}),r.get("/profile/settings/dutyDay",async(t,s)=>{g.profile.settings.dutyDay(Number(t.query.user),Number(t.query.day)),s.send()}),r.get("/profile/settings/name",async(t,s)=>{g.profile.settings.name(Number(t.query.user),String(t.query.name)),s.send()}),r.get("/profile/info/refKey",async(t,s)=>{let o=await g.profile.info.refKey(Number(t.query.user),String(t.query.refKey));s.send({alert:o})}),r.get("/profile/info/monthPay",async(t,s)=>{let o=g.profile.info.monthPay(Number(t.query.user),Number(t.query.months));s.send({alert:o})}),r.get("/settings/notifications/table",async(t,s)=>{s.send(g.settings.notifications.table(Number(t.query.user)))}),r.get("/settings/notifications/schedule",async(t,s)=>{g.settings.notifications.schedule(Number(t.query.user)),s.send()}),r.get("/settings/notifications/replacement",async(t,s)=>{g.settings.notifications.replacement(Number(t.query.user)),s.send()}),r.get("/settings/notifications/duty",async(t,s)=>{g.settings.notifications.duty(Number(t.query.user)),s.send()}),r.get("/settings/theme/table",async(t,s)=>{s.send(g.settings.theme.table(Number(t.query.user)))}),r.post("/settings/theme/background",async(t,s)=>{g.settings.theme.background(Number(t.query.user),String(t.query.url)),s.send()}),r.post("/settings/theme/lightMode",async(t,s)=>{g.settings.theme.lightMode(Number(t.query.user)),s.send()}),r.get("/gradient",async(t,s)=>{s.send(g.gradient(Number(t.query.user)))}),qt.default.createServer(r).listen(5e3,"localhost")};var Ct=async r=>{let e=r.chat?.id;if(e)try{let t=n.users.getUser(e),s=Date.now(),o=new Date().getDay();if(!t){await r.reply(u.notfoundMessages.user);return}if(o!==0&&t.payment.status!==0&&t.duty.lastDate+432e5<=s){let a=n.groups.getGroup(t.info.groupName);if(!a){await r.reply(u.notfoundMessages.group);return}a.duty.insertDuty(s,t.info.id,t.info.name),t.duty.count+=1,t.duty.lastDate=s;let i=a.users.filter(m=>(m.info.role==="admin"||m.duty.day===o)&&m.info.groupName===t.info.groupName);for(let m of i)m.sendText(`${t.info.name} \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B, \u0435\u0441\u043B\u0438 \u043D\u0435\u0442 \u043E\u0431\u0440\u0430\u0442\u0438\u0442\u0435\u0441\u044C \u043A \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0443`);await r.reply("\u0423\u0441\u043F\u0435\u0448\u043D\u043E")}else await r.reply("\u0421\u0435\u0433\u043E\u0434\u043D\u044F \u0432\u043E\u0441\u043A\u0440\u0435\u0441\u0435\u043D\u044C\u0435, \u0432\u044B \u0443\u0436\u0435 \u043E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B\u0438 \u0438\u043B\u0438 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u044B")}catch(t){console.log(`Error processing duty: ${t}`),await n.telegram.sendMessage(e,"\u041F\u0440\u043E\u0438\u0437\u043E\u0448\u043B\u0430 \u043E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435 \u0432\u0430\u0448\u0435\u0433\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u0430.")}};var Lt={duty:Ct};var Gt=()=>{n.hears("\u041E\u0442\u0434\u0435\u0436\u0443\u0440\u0438\u043B",async r=>{await Lt.duty(r)})};var v={CallbackQueryHandler:ke,CommandsHandler:Ye,CronHandler:et,WebHandler:Nt,HearsHandler:Gt};var n=new Q;(async()=>(console.log("\u0414\u0435\u0432 \u043C\u043E\u0434: ",n.devMode),await n.addGradients(),await n.addUsers(),await n.addGroups(),await n.addReplacements(),v.WebHandler(),v.CommandsHandler(),v.CallbackQueryHandler(),v.HearsHandler(),v.CronHandler(),n.launchBot()))();0&&(module.exports={bot});
